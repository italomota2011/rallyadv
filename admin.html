<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Painel Admin Rally - Oficial</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100%; width: 100%; background: #1a202c; overflow: hidden; font-family: sans-serif; }
        #toolbar { height: 60px; background: #2d3748; display: flex; align-items: center; padding: 0 15px; gap: 10px; z-index: 9999; position: relative; }
        #map { height: calc(100vh - 60px); width: 100%; display: block; background: #a0aec0; }
        button { padding: 8px 12px; background: #4a5568; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 11px; }
        button:hover { background: #718096; }
        .btn-apurar { background: #38a169; }
        .btn-rastro { background: #3182ce; }
        .btn-danger { background: #e53e3e; }
        .logo-admin { height: 40px; border-radius: 50%; border: 2px solid #e67e22; }
    </style>
</head>
<body>

    <div id="toolbar">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s" class="logo-admin">
        <button onclick="salvarPercurso()" style="background: #e67e22;">SALVAR PERCURSO</button>
        <button class="btn-apurar" onclick="processarPenalidades()">PROCESSAR APURAÇÃO</button>
        <button class="btn-rastro" onclick="location.href='rastro.html'">VER RASTROS</button>
        <button onclick="location.href='tempos.html'">TEMPOS</button>
        <button onclick="location.href='fotos.html'">FOTOS</button>
        <button class="btn-danger" onclick="resetar()">LIMPAR TUDO</button>
        <div style="color: #cbd5e0; font-size: 10px; margin-left: auto;">ADMIN V2.1</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const map = L.map('map').setView([-12.25, -38.95], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        const drawnItems = new L.FeatureGroup().addTo(map);
        const drawControl = new L.Control.Draw({
            edit: { featureGroup: drawnItems },
            draw: { polygon: true, circle: true, marker: false, polyline: false, rectangle: false }
        });
        map.addControl(drawControl);

        // Carregar percurso salvo
        db.ref('configuracoes/percurso').once('value', snap => {
            if(snap.val()) {
                L.geoJSON(snap.val(), {
                    pointToLayer: (geojson, latlng) => {
                        return L.circle(latlng, {radius: geojson.properties.radius});
                    },
                    onEachFeature: (f, l) => {
                        if(f.properties.velocidade) l.bindPopup("V.Max: " + f.properties.velocidade);
                        drawnItems.addLayer(l);
                    }
                });
            }
        });

        map.on(L.Draw.Event.CREATED, e => {
            const layer = e.layer;
            if (e.layerType === 'polygon') {
                const vel = prompt("Velocidade Máxima (km/h):", "60");
                layer.feature = layer.feature || {type: "Feature", properties: {}};
                layer.feature.properties.velocidade = parseInt(vel) || 60;
            }
            if (e.layerType === 'circle') {
                layer.feature = layer.feature || {type: "Feature", properties: {}};
                layer.feature.properties.type = 'circle';
                layer.feature.properties.radius = layer.getRadius();
            }
            drawnItems.addLayer(layer);
        });

        window.salvarPercurso = function() {
            const data = drawnItems.toGeoJSON();
            db.ref('configuracoes/percurso').set(data)
                .then(() => alert("Percurso salvo com sucesso!"));
        };

        window.processarPenalidades = async function() {
            if(!confirm("Deseja calcular as penalidades de todos os carros agora?")) return;

            const [snapRastros, snapConfig, snapCompetidores] = await Promise.
