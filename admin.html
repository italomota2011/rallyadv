<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Admin - Controle Rally</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-geosearch@3.8.0/dist/geosearch.css" />
    <style>
        body { font-family: sans-serif; margin: 0; }
        #map { height: 75vh; width: 100%; }
        .panel { padding: 15px; background: #2c3e50; color: white; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        button { cursor: pointer; padding: 8px 12px; font-weight: bold; border-radius: 4px; border: none; }
        .btn-save { background: #27ae60; color: white; }
        .btn-reset { background: #c0392b; color: white; }
        .btn-calc { background: #f39c12; color: white; }
    </style>
</head>
<body>
    <div class="panel">
        <div id="search-container" style="width: 300px; color: black;"></div>
        <button onclick="toggleMap()">Alternar Satélite</button>
        <button class="btn-save" onclick="saveConfig()">Salvar Percurso/Radares</button>
        <button class="btn-calc" onclick="apurarResultados()">FINALIZAR E APURAR PROVA</button>
        <button class="btn-reset" onclick="resetRace()">REINICIAR TUDO</button>
        <a href="resultados.html"><button>Ranking</button></a>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://unpkg.com/leaflet-geosearch@3.8.0/dist/bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { /* SEU CONFIG AQUI */ };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Mapa e Camadas
        const map = L.map('map').setView([-23.55, -46.63], 10);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

        // Busca de Cidade
        const searchControl = new GeoSearch.GeoSearchControl({
            provider: new GeoSearch.OpenStreetMapProvider(),
            style: 'bar',
            container: document.getElementById('search-container')
        });
        map.addControl(searchControl);

        // Desenho
        const drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);
        const drawControl = new L.Control.Draw({
            draw: { marker: false, circlemarker: false },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, (e) => {
            const layer = e.layer;
            if (e.layerType === 'rectangle') {
                layer.options.speedLimit = prompt("Velocidade Máxima (km/h):", "60");
            }
            drawnItems.addLayer(layer);
        });

        // Funções Globais
        window.toggleMap = () => map.hasLayer(osm) ? (map.removeLayer(osm), sat.addTo(map)) : (map
