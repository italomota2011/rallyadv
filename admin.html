<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Sistema de Controle de Prova</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --danger: #c0392b; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; }
        
        #header { background: var(--primary); color: white; padding: 10px 20px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; }
        #map { flex-grow: 1; z-index: 1; }

        .controls-group { display: flex; gap: 8px; align-items: center; border-right: 1px solid #555; padding-right: 15px; }
        input[type="text"] { padding: 8px; border-radius: 4px; border: none; width: 200px; }
        
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-blue { background: var(--accent); }
        .btn-green { background: var(--success); }
        .btn-red { background: var(--danger); }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }

        /* Estilo para os popups de configura√ß√£o de radar */
        .leaflet-popup-content input { width: 80px; margin-top: 5px; }
    </style>
</head>
<body>

<header id="header">
    <div class="controls-group">
        <input type="text" id="cityInput" placeholder="Buscar cidade (Ex: S√£o Paulo)">
        <button class="btn btn-blue" onclick="searchCity()">Buscar</button>
    </div>

    <div class="controls-group">
        <button class="btn btn-blue" onclick="toggleSatellite()">üõ∞Ô∏è Sat√©lite</button>
        <button class="btn btn-green" onclick="saveToFirebase()">üíæ Salvar Configura√ß√£o</button>
    </div>

    <div class="controls-group">
        <button class="btn btn-blue" onclick="window.location.href='rastro.html'">üìç Rastro</button>
        <button class="btn btn-blue" onclick="window.location.href='resultados.html'">üìä Resultados</button>
    </div>

    <button class="btn btn-red" onclick="resetSystem()">‚ö†Ô∏è Reiniciar Prova</button>
</header>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "SUA_API_KEY",
        authDomain: "SEU_PROJETO.firebaseapp.com",
        databaseURL: "https://SEU_PROJETO.firebaseio.com",
        projectId: "SEU_PROJETO",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2. MAPA E LAYERS
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    
    const map = L.map('map', {
        center: [-23.5505, -46.6333],
        zoom: 13,
        layers: [osm]
    });

    function toggleSatellite() {
        if (map.hasLayer(osm)) {
            map.removeLayer(osm);
            satellite.addTo(map);
        } else {
            map.removeLayer(satellite);
            osm.addTo(map);
        }
    }

    // 3. BUSCA DE CIDADE (Nominatim API gratuita)
    async function searchCity() {
        const city = document.getElementById('cityInput').value;
        if(!city) return;
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${city}`);
        const data = await resp.json();
        if(data.length > 0) {
            map.setView([data[0].lat, data[0].lon], 13);
        } else {
            alert("Cidade n√£o encontrada.");
        }
    }

    // 4. FERRAMENTAS DE DESENHO
    const drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: {
            polygon: false,
            marker: false,
            circlemarker: false,
            polyline: { shapeOptions: { color: '#3498db', weight: 5 }, title: 'Desenhar Percurso' },
            rectangle: { shapeOptions: { color: '#e74c3c', fillOpacity: 0.3 }, title: 'Radar de Velocidade' },
            circle: { shapeOptions: { color: '#f1c40f' }, title: 'Waypoint (Obrigat√≥rio)' }
        }
    });
    map.addControl(drawControl);

    // Manipula√ß√£o do que foi desenhado
    map.on(L.Draw.Event.CREATED, function (e) {
        const layer = e.layer;
        const type = e.layerType;

        if (type === 'rectangle') {
            const vel = prompt("Velocidade m√°xima permitida neste radar (km/h):", "60");
            layer.options.speedLimit = parseInt(vel);
            layer.bindPopup(`<b>Radar Virtual</b><br>Limite: ${vel} km/h`).openPopup();
        }
        
        if (type === 'circle') {
            layer.bindPopup(`<b>Waypoint</b><br>Passagem Obrigat√≥ria`).openPopup();
        }

        drawnItems.addLayer(layer);
    });

    // 5. PERSIST√äNCIA E SEGURAN√áA
    function saveToFirebase() {
        const geoData = drawnItems.toGeoJSON();
        
        // Adicionamos as propriedades customizadas (velocidade e raio) que o toGeoJSON nativo pode omitir
        geoData.features.forEach((feature, index) => {
            const layer = Object.values(drawnItems._layers)[index];
            if(layer.options.speedLimit) feature.properties.speedLimit = layer.options.speedLimit;
            if(layer._mRadius) feature.properties.radius = layer._mRadius;
        });

        db.ref('prova/configuracao').set({
            desenhos: geoData,
            atualizadoEm: Date.now()
        }).then(() => alert("Configura√ß√µes de percurso, radares e waypoints salvas!"));
    }

    function resetSystem() {
        const pass = prompt("Para APAGAR TUDO e reiniciar, digite a senha:");
        if (pass === "261291") {
            db.ref('prova').remove().then(() => {
                // Criar os 100 carros iniciais
                const updates = {};
                for(let i=1; i<=100; i++) {
                    updates[`carros/carro_${i}`] = {
                        id: i,
                        pontos: 150000,
                        lat: 0,
                        lng: 0,
                        velocidade: 0,
                        historico: [] // Onde ser√£o salvos os rastros
                    };
                }
                db.ref('prova').update(updates);
                drawnItems.clearLayers();
                alert("Sistema reiniciado com sucesso!");
            });
        } else {
            alert("Senha incorreta!");
        }
    }
</script>

</body>
</html>
