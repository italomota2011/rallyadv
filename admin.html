<!DOCTYPE html>
<html>
<head>
    <title>Painel Admin - Rally Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 100%; }
        .controls { padding: 10px; background: #f4f4f4; display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" id="citySearch" placeholder="Buscar cidade...">
        <button onclick="setRouteMode()">Definir Rota</button>
        <button onclick="setRadarMode()">Criar Radar</button>
        <button onclick="setWaypointMode()">Criar Waypoint</button>
        <button onclick="processarProva()" style="background: #ffcc00;">Finalizar e Apurar</button>
        <button onclick="resetarProva()" style="background: #ff4444; color: white;">Reiniciar Tudo</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { /* SEU CONFIG AQUI */ };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Inicializar Mapa
        const map = L.map('map').setView([-23.55, -46.63], 13);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

        L.control.layers({"Mapa": osm, "Satélite": satellite}).addTo(map);

        let markers = {};

        // Rastreio em Tempo Real
        onValue(ref(db, 'competidores'), (snapshot) => {
            const data = snapshot.val();
            for (let id in data) {
                const c = data[id];
                if (markers[id]) {
                    markers[id].setLatLng([c.lat, c.lng]);
                } else {
                    markers[id] = L.marker([c.lat, c.lng], {
                        icon: L.divIcon({html: `<b>${id}</b>`, className: 'car-icon'})
                    }).addTo(map).bindPopup(`Carro: ${id}<br>Vel: ${c.vel} km/h<br>Piloto: ${c.nome}`);
                }
            }
        });

        // Lógica de Apuração (Simplificada)
        window.processarProva = async () => {
            alert("Iniciando cruzamento de dados de GPS com áreas de radar e waypoints...");
            // Aqui entraria o loop comparando historico/ com as coordenadas das áreas criadas
        };

        window.resetarProva = () => {
            if(confirm("Apagar todos os dados?")) set(ref(db, '/'), { config: {}, competidores: {}, historico: {} });
        };
    </script>
</body>
</html>
