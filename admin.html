<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Painel Admin - Rally Tracker</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

    <style>
        /* GARANTE QUE O MAPA APAREÇA */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #map {
            flex-grow: 1; /* Ocupa todo o espaço restante */
            width: 100%;
            background: #e5e3df; /* Cor de fundo caso o mapa demore a carregar */
        }

        .panel { 
            padding: 15px; 
            background: #1a1a1a; 
            color: white; 
            display: flex; 
            gap: 10px; 
            align-items: center;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .results-area { 
            height: 150px; 
            overflow-y: auto; 
            background: #ffffff; 
            padding: 10px; 
            font-family: monospace;
            font-size: 12px; 
            border-top: 3px solid #ffc107;
            color: #333;
        }

        button { 
            padding: 10px 15px; 
            cursor: pointer; 
            border-radius: 4px; 
            border: none; 
            font-weight: bold; 
            transition: 0.3s;
        }

        .btn-save { background: #28a745; color: white; }
        .btn-save:hover { background: #218838; }
        .btn-calc { background: #dc3545; color: white; }
        .btn-calc:hover { background: #c82333; }
    </style>
</head>
<body>

<div class="panel">
    <strong>RALLY ADMIN</strong>
    <button class="btn-save" onclick="saveConfig()">1. Salvar Configuração</button>
    <button class="btn-calc" onclick="processRankings()">2. Processar Apuração</button>
    <span id="status" style="margin-left: auto; color: #00ff00;">● Sistema Online</span>
</div>

<div id="map"></div>

<div id="results" class="results-area">
    Console de Apuração: Aguardando comando...
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<script>
    // Configuração do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
        authDomain: "cronometro-rally.firebaseapp.com",
        databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
        projectId: "cronometro-rally",
        storageBucket: "cronometro-rally.firebasestorage.app",
        messagingSenderId: "341731891354",
        appId: "1:341731891354:web:d0c34265be68015e98a723"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let map;
    let drawnItems;
    let carMarkers = {};

    // INICIALIZAÇÃO DO MAPA
    function initMap() {
        map = L.map('map').setView([-23.55, -46.63], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        const drawControl = new L.Control.Draw({
            draw: {
                polygon: false,
                rectangle: false,
                circlemarker: false,
                marker: false,
                polyline: { shapeOptions: { color: '#f357a1' } },
                circle: { shapeOptions: { color: '#2563eb' } }
            },
            edit: { featureGroup: drawnItems }
        });
        map.addControl(drawControl);

        // Ao criar um círculo (Radar ou Waypoint)
        map.on(L.Draw.Event.CREATED, (e) => {
            const layer = e.layer;
            if(e.layerType === 'circle') {
                const limit = prompt("Limite de Velocidade (km/h)?\n(Digite 0 para Waypoint comum)");
                layer.options.speedLimit = parseFloat(limit) || 0;
                layer.bindPopup(layer.options.speedLimit > 0 ? `Radar: ${layer.options.speedLimit}km/h` : "Waypoint").openPopup();
            }
            drawnItems.addLayer(layer);
        });

        // Força o mapa a se ajustar ao tamanho da tela
        setTimeout(() => { map.invalidateSize(); }, 500);
    }

    // Monitoramento em Tempo Real
    db.ref('live_tracking').on('value', snapshot => {
        const cars = snapshot.val();
        for(let id in cars) {
            const {lat, lng, speed} = cars[id];
            if(carMarkers[id]) {
                carMarkers[id].setLatLng([lat, lng])
                             .setPopupContent(`<b>Carro ${id}</b><br>Velocidade: ${speed.toFixed(1)} km/h`);
            } else {
                carMarkers[id] = L.marker([lat, lng]).addTo(map)
                                  .bindPopup(`Carro ${id}`).openPopup();
            }
        }
    });

    function saveConfig() {
        const config = [];
        drawnItems.eachLayer(layer => {
            if (layer instanceof L.Circle) {
                config.push({
                    latlng: layer.getLatLng(),
                    radius: layer.getRadius(),
                    speedLimit: layer.options.speedLimit || 0
                });
            }
        });
        db.ref('race_config').set(config).then(() => alert("Configuração salva!"));
    }

    async function processRankings() {
        const configSnap = await db.ref('race_config').once('value');
        const historySnap = await db.ref('history').once('value');
        const config = configSnap.val();
        const history = historySnap.val();

        if(!config) return alert("Desenhe os Waypoints/Radares primeiro!");
        if(!history) return alert("Nenhum dado de competidor encontrado!");

        let finalScores = {};
        const logDiv = document.getElementById('results');
        logDiv.innerHTML = "<strong>Iniciando Apuração...</strong><br>";

        for (let carId in history) {
            let score = 1000;
            let penalties = [];
            const carData = Object.values(history[carId]);

            config.forEach((point, idx) => {
                let passed = false;
                let speedExceeded = false;

                carData.forEach(pos => {
                    const dist = map.distance([pos.lat, pos.lng], [point.latlng.lat, point.latlng.lng]);
                    if (dist <= point.radius) {
                        passed = true;
                        if (point.speedLimit > 0 && pos.speed > point.speedLimit) {
                            speedExceeded = true;
                        }
                    }
                });

                if (!passed) {
                    score -= 10;
                    penalties.push(`Pulou WP ${idx+1}`);
                } else if (speedExceeded) {
                    score -= 10;
                    penalties.push(`Velocidade no Radar ${idx+1}`);
                }
            });

            finalScores[carId] = { score, penalties };
            logDiv.innerHTML += `Carro ${carId}: ${score} pts | Falhas: ${penalties.length}<br>`;
        }
        db.ref('final_rankings').set(finalScores);
    }

    window.onload = initMap;
</script>
</body>
</html>