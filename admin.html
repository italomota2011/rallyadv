<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Painel Admin Rally</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        html, body { margin: 0; padding: 0; height: 100vh; width: 100vw; background: #1a202c; overflow: hidden; }
        
        /* Menu Superior */
        #toolbar { 
            height: 60px; 
            background: #2d3748; 
            display: flex; 
            align-items: center; 
            padding: 0 15px; 
            gap: 10px;
            z-index: 9999;
            position: relative;
        }

        /* Mapa Ocupando o resto da tela */
        #map { 
            height: calc(100vh - 60px); 
            width: 100%; 
            background: #a0aec0; 
        }

        button { 
            padding: 8px 15px; 
            background: #4a5568; 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer;
            font-weight: bold;
        }
        
        button:hover { background: #718096; }
        input { padding: 8px; border-radius: 4px; border: none; }
    </style>
</head>
<body>

    <div id="toolbar">
        <input type="text" id="cityInput" placeholder="Cidade...">
        <button onclick="buscar()">Buscar</button>
        <button onclick="salvar()" style="background: #38a169;">Salvar Trajeto</button>
        <button onclick="apurar()" style="background: #dd6b20;">Rodar Apuração</button>
        <button onclick="window.location.href='resultados.html'">Ranking</button>
        <button onclick="resetar()" style="background: #e53e3e;">Reset</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        console.log("Script carregado. Iniciando Firebase...");

        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            storageBucket: "cronometro-rally.firebasestorage.app",
            messagingSenderId: "341731891354",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };

        let db, map;

        try {
            const app = firebase.initializeApp(firebaseConfig);
            db = firebase.database(app);
            console.log("Firebase OK");
        } catch (e) {
            alert("Erro Firebase: " + e.message);
        }

        // Inicialização do Mapa
        function initMap() {
            try {
                console.log("Tentando renderizar mapa...");
                map = L.map('map').setView([-12.26, -38.96], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
                console.log("Mapa Renderizado com sucesso.");
            } catch (e) {
                console.error("Erro no Leaflet:", e);
                document.getElementById('map').innerHTML = "<h1 style='color:white; padding:20px;'>Erro ao carregar mapa: " + e.message + "</h1>";
            }
        }

        // Funções dos botões anexadas ao objeto global window
        window.buscar = async function() {
            const q = document.getElementById('cityInput').value;
            if(!q) return;
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
            const data = await res.json();
            if(data[0]) map.setView([data[0].lat, data[0].lon], 14);
        };

        window.salvar = function() {
            alert("Botão Salvar clicado!");
        };

        window.apurar = function() {
            alert("Botão Apurar clicado!");
        };

        window.resetar = function() {
            if(confirm("Resetar tudo?")) db.ref('/').remove().then(() => location.reload());
        };

        // Dispara a inicialização
        window.onload = initMap;
    </script>
</body>
</html>
