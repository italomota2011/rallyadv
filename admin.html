<!DOCTYPE html>
<html>
<head>
    <title>Painel Admin - Rally Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <style>
        #map { height: 600px; width: 100%; }
        .controls { padding: 10px; background: #eee; display: flex; gap: 10px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="controls">
        <input type="text" id="citySearch" placeholder="Buscar cidade...">
        <button onclick="searchCity()">Buscar</button>
        <button onclick="toggleSatelite()">Alternar Satélite</button>
        <button onclick="finalizarProva()" style="background: red; color: white;">Finalizar e Apurar</button>
        <button onclick="resetarProva()">Reiniciar Prova</button>
    </div>
    <div id="map"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script>
        const firebaseConfig = { /* SEU CONFIG AQUI */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Inicialização do Mapa
        const map = L.map('map').setView([-23.55, -46.63], 10);
        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

        function toggleSatelite() {
            map.hasLayer(osm) ? (map.removeLayer(osm), satelite.addTo(map)) : (map.removeLayer(satelite), osm.addTo(map));
        }

        // Ferramentas de Desenho (Percurso, Radares, Waypoints)
        const drawnItems = new L.FeatureGroup().addTo(map);
        const drawControl = new L.Control.Draw({
            draw: { polygon: false, circle: false, circlemarker: false, 
                    polyline: true, rectangle: true, marker: true }
        });
        map.addControl(drawControl);

        map.on(L.Draw.Event.CREATED, function (e) {
            const type = e.layerType;
            const layer = e.layer;
            
            if (type === 'rectangle') {
                const vel = prompt("Defina a velocidade máxima para este radar (km/h):");
                layer.options.maxSpeed = vel;
                db.ref('configuracao/radares').push({ coords: layer.getBounds(), speed: vel });
            }
            if (type === 'polyline') {
                db.ref('configuracao/percurso').set(layer.getLatLngs());
            }
            if (type === 'marker') {
                db.ref('configuracao/waypoints').push(layer.getLatLng());
            }
            drawnItems.addLayer(layer);
        });

        // Monitoramento em Tempo Real
        const markers = {};
        db.ref('competidores').on('value', snapshot => {
            const data = snapshot.val();
            for (let id in data) {
                const c = data[id];
                const label = `Carro ${c.numero} - ${c.velocidade}km/h`;
                if (markers[id]) {
                    markers[id].setLatLng([c.lat, c.lng]).setPopupContent(label);
                } else {
                    markers[id] = L.marker([c.lat, c.lng]).addTo(map)
                        .bindPopup(label).bindTooltip(c.numero.toString(), {permanent: true});
                }
            }
        });

        function resetarProva() {
            if(confirm("Deseja apagar TUDO?")) {
                db.ref('/').remove();
                location.reload();
            }
        }
    </script>
</body>
</html>
