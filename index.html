<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Rally - Competidor</title>
    <style>
        body { font-family: sans-serif; background: #1a202c; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .card { background: #2d3748; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); text-align: center; width: 90%; max-width: 400px; }
        #status { font-size: 1.2em; margin-bottom: 20px; color: #f6ad55; }
        #speed { font-size: 3em; font-weight: bold; margin: 10px 0; color: #68d391; }
        .info { font-size: 0.9em; color: #a0aec0; margin-bottom: 5px; }
        input { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: none; background: #1a202c; color: white; text-align: center; font-size: 1.1em; }
        button { width: 100%; padding: 15px; border-radius: 8px; border: none; background: #ed8936; color: white; font-weight: bold; font-size: 1.2em; cursor: pointer; }
        button:disabled { background: #4a5568; cursor: not-allowed; }
    </style>
</head>
<body>

    <div class="card">
        <h2>TransmissÃ£o Rally</h2>
        <input type="number" id="carId" placeholder="NÃºmero do Carro (Ex: 01)">
        <input type="text" id="carName" placeholder="Nome do Piloto">
        
        <div id="status">ðŸ”´ Desconectado</div>
        <div class="info">Velocidade Atual:</div>
        <div id="speed">0 <span style="font-size: 0.4em;">KM/H</span></div>
        
        <button id="startBtn" onclick="toggleTracking()">Iniciar Corrida</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let watchId = null;
        let isTracking = false;

        function toggleTracking() {
            const id = document.getElementById('carId').value;
            const nome = document.getElementById('carName').value;

            if(!id || !nome) return alert("Preencha o NÃºmero do Carro e o Nome!");

            if (!isTracking) {
                // Iniciar
                isTracking = true;
                document.getElementById('startBtn').innerText = "Encerrar Corrida";
                document.getElementById('startBtn').style.background = "#e53e3e";
                document.getElementById('status').innerText = "ðŸŸ¢ Transmitindo...";
                
                // Salva o nome do competidor no banco
                db.ref('competidores/' + id).update({ nome: nome, pontos: 150000 });

                startGps(id);
            } else {
                // Parar
                location.reload(); // Recarrega para limpar tudo de forma segura
            }
        }

        function startGps(id) {
            if ("geolocation" in navigator) {
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        // Converte velocidade de m/s para km/h (o GPS envia m/s)
                        const speedKmh = pos.coords.speed ? (pos.coords.speed * 3.6) : 0;
                        
                        document.getElementById('speed').innerHTML = `${Math.round(speedKmh)} <span style="font-size: 0.4em;">KM/H</span>`;

                        const dados = {
                            lat: pos.coords.latitude,
                            lng: pos.coords.longitude,
                            vel: speedKmh,
                            time: Date.now()
                        };

                        // 1. Atualiza posiÃ§Ã£o atual (para o Admin ver no mapa)
                        db.ref('posicoes/' + id).set(dados);

                        // 2. Registra o rastro (para a apuraÃ§Ã£o final)
                        db.ref('rastros/' + id).push(dados);
                    },
                    (err) => console.error(err),
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }
    </script>
</body>
</html>
