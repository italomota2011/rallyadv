<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Rally - Competidor</title>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #eee; }
        input, select, button { width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; }
        button { background: #28a745; color: white; font-weight: bold; border: none; }
        #status { font-weight: bold; color: #d9534f; }
    </style>
</head>
<body>
    <h1>Painel do Piloto</h1>
    <input type="text" id="nome" placeholder="Seu Nome">
    <input type="number" id="carro" placeholder="Número do Carro (1-100)" min="1" max="100">
    <select id="categoria">
        <option value="4x2">Categoria 4x2</option>
        <option value="4x4">Categoria 4x4</option>
    </select>
    <button id="btnConectar">INICIAR RASTREAMENTO</button>
    <p id="status">Status: Desconectado</p>
    <h2 id="displayVel">0 km/h</h2>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = { /* SEU CONFIG AQUI */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    document.getElementById('btnConectar').onclick = function() {
        const num = document.getElementById('carro').value;
        const nome = document.getElementById('nome').value;
        const cat = document.getElementById('categoria').value;

        if(!num || !nome) return alert("Preencha tudo!");

        this.disabled = true;
        this.innerText = "RASTREANDO...";
        this.style.background = "#555";

        navigator.geolocation.watchPosition((pos) => {
            const velKmh = Math.round((pos.coords.speed || 0) * 3.6);
            document.getElementById('displayVel').innerText = velKmh + " km/h";
            document.getElementById('status').innerText = "Status: ONLINE";
            document.getElementById('status').style.color = "green";

            const payload = {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                vel: velKmh,
                nome: nome,
                categoria: cat,
                pontos: 150000,
                ultimaAtualizacao: Date.now()
            };

            // 1. Localização Atual (para o mapa do admin)
            update(ref(db, `competidores/${num}`), payload);
            
            // 2. Histórico (para apuração final)
            push(ref(db, `historico/${num}`), {
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                vel: velKmh,
                t: Date.now()
            });

        }, (err) => alert("Erro no GPS: " + err.message), {
            enableHighAccuracy: true,
            maximumAge: 0
        });
    };
</script>
</body>
</html>
