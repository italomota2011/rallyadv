<script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        let wakeLock = null;
        let watchID = null;
        let ultimaPos = null;

        // --- BLOCO DE RECUPERA칂츾O PRIORIT츼RIA ---
        // Lemos o valor antes de qualquer outra coisa rodar
        let odoTotal = parseFloat(localStorage.getItem('rally_odo_total')) || 0;

        function atualizarTelaOdo() { 
            const display = document.getElementById('displayOdo');
            if (display) {
                display.innerText = odoTotal.toFixed(3);
            }
            // Salva sempre como string para evitar erros de leitura do navegador
            localStorage.setItem('rally_odo_total', odoTotal.toString()); 
        }

        // --- FUN칂칏ES DE AJUSTE ---
        function alterarOdo(v) { 
            odoTotal = Math.max(0, odoTotal + v); 
            atualizarTelaOdo(); 
        }

        function zerarOdo() { 
            if(confirm("Zerar od칪metro?")) { 
                odoTotal = 0; 
                atualizarTelaOdo(); 
            } 
        }

        function ajusteManualOdo() {
            let n = prompt("Ajustar Od칪metro (KM):", odoTotal.toFixed(3));
            if(n !== null) { 
                let val = parseFloat(n.replace(',','.'));
                if(!isNaN(val)) {
                    odoTotal = Math.max(0, val);
                    atualizarTelaOdo();
                }
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        // --- RASTREIO E GPS ---
        function iniciarFluxoRastreio(num) {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('ativo').style.display = 'block';
            document.getElementById('viewCarro').innerText = "Carro " + num;
            
            // For칞a o valor guardado a aparecer imediatamente
            atualizarTelaOdo();
            solicitarWakeLock();

            watchID = navigator.geolocation.watchPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speedMS = position.coords.speed || 0;
                const kmh = Math.round(speedMS * 3.6);

                if (accuracy > 30) return;

                if (ultimaPos) {
                    const dist = calcularDistancia(ultimaPos.lat, ultimaPos.lng, lat, lng);
                    if (dist > 0.002) { // Movimentos acima de 2 metros
                        odoTotal += dist;
                        atualizarTelaOdo();
                        ultimaPos = { lat, lng }; 
                    }
                } else {
                    ultimaPos = { lat, lng };
                }

                document.getElementById('viewVel').innerText = kmh.toFixed(1);
                db.ref('posicoes/' + num).set({ lat, lng, vel: kmh, acc: accuracy, ts: Date.now() });
            }, (err) => { console.error(err); }, { enableHighAccuracy: true, maximumAge: 0 });
        }

        // --- CARREGAMENTO INICIAL ---
        window.onload = function() {
            // Garante que o visor mostre o que est치 na mem칩ria mal a p치gina abra
            atualizarTelaOdo();

            const salvo = localStorage.getItem('rally_carro_ativo');
            if (salvo) {
                iniciarFluxoRastreio(salvo);
            }
        };

        async function solicitarWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        document.getElementById('btnIniciar').onclick = async function() {
            const numRaw = document.getElementById('carro').value;
            const nomeRaw = document.getElementById('nome').value.trim();
            const cat = document.getElementById('categoria').value;
            const num = parseInt(numRaw);

            if(!nomeRaw || !numRaw) return alert("Preencha todos os campos!");
            
            try {
                const statusSnap = await db.ref('configuracoes/provaAberta').once('value');
                if (statusSnap.val() !== true) return alert("游뛂 A prova est치 fechada.");

                await db.ref('competidores/' + num).set({ nome: nomeRaw, categoria: cat });
                localStorage.setItem('rally_carro_ativo', num);
                iniciarFluxoRastreio(num);
            } catch (e) { alert("Erro de liga칞칚o."); }
        };

        function encerrarSessao() {
            if(confirm("Encerrar prova? Isto limpar치 os dados de od칪metro do telem칩vel.")) {
                if (watchID) navigator.geolocation.clearWatch(watchID);
                localStorage.removeItem('rally_carro_ativo');
                localStorage.removeItem('rally_odo_total');
                location.reload();
            }
        }
    </script>

