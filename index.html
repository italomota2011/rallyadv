<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
        authDomain: "cronometro-rally.firebaseapp.com",
        databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
        projectId: "cronometro-rally",
        appId: "1:341731891354:web:d0c34265be68015e98a723"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let watchID = null, wakeLock = null, distTotal = 0, ultimaPos = null;

    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function atualizarDisplay() {
        document.getElementById('viewDist').innerText = distTotal.toFixed(3);
        localStorage.setItem('rally_distancia', distTotal);
    }

    function iniciarFluxoRastreio(num) {
        document.getElementById('setup').style.display = 'none';
        document.getElementById('ativo').style.display = 'block';
        document.getElementById('viewCarro').innerText = "CARRO " + num;

        const salva = localStorage.getItem('rally_distancia');
        if(salva) { distTotal = parseFloat(salva); atualizarDisplay(); }

        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').catch(()=>{});
        }

        db.ref(".info/connected").on("value", s => {
            const m = document.getElementById('msgGps');
            m.innerText = s.val() ? "● TRANSMITINDO AO VIVO" : "○ MODO OFFLINE";
        });

        watchID = navigator.geolocation.watchPosition(p => {
            const lat = p.coords.latitude;
            const lng = p.coords.longitude;
            const vel = (p.coords.speed || 0) * 3.6;
            const accuracy = p.coords.accuracy;

            document.getElementById('viewVel').innerText = vel > 2.5 ? vel.toFixed(1) : "0.0";

            // --- FILTRO DE ESTABILIDADE (MANTIDO INTACTO) ---
            if (accuracy < 30) {
                if (ultimaPos && vel > 3.0) {
                    const trecho = calcularDistancia(ultimaPos.lat, ultimaPos.lng, lat, lng);
                    if (trecho > 0.005 && trecho < 0.2) {
                        distTotal += trecho;
                        atualizarDisplay();
                    }
                }
                ultimaPos = { lat, lng };
            }
            // ------------------------------------------------

            db.ref('posicoes/' + num).set({ lat, lng, vel: vel.toFixed(1), ts: Date.now() });
        }, null, { enableHighAccuracy: true });
    }

    document.getElementById('btnIniciar').onclick = async function() {
        const numRaw = document.getElementById('carro').value;
        const nome = document.getElementById('nome').value.trim();
        const cat = document.getElementById('categoria').value;

        if(!numRaw || !nome) {
            alert("Por favor, preencha o Nome e o Número do Carro!");
            return;
        }

        // Converte para número puro (ex: "01" vira 1)
        const numCarro = parseInt(numRaw, 10);

        if (isNaN(numCarro) || numCarro <= 0 || numCarro > 100) {
            alert("O número do carro deve estar entre 1 e 100!");
            return;
        }

        try {
            const snapshot = await db.ref('competidores').once('value');
            const competidores = snapshot.val();

            if (competidores) {
                for (let id in competidores) {
                    // Verifica duplicidade comparando como números
                    if (parseInt(id, 10) === numCarro) {
                        alert("Este número de carro (" + numCarro + ") já está em uso!");
                        return;
                    }
                    if (competidores[id].nome.toLowerCase() === nome.toLowerCase()) {
                        alert("Este nome de piloto já está cadastrado!");
                        return;
                    }
                }
            }

            await db.ref('competidores/' + numCarro).set({ nome, categoria: cat });
            localStorage.setItem('rally_carro_ativo', numCarro);
            iniciarFluxoRastreio(numCarro);
            
        } catch (e) {
            console.error(e);
            iniciarFluxoRastreio(numCarro);
        }
    };

    // Handlers de Odômetro (MANTIDOS INTACTOS)
    document.getElementById('viewDist').onclick = function() {
        this.style.display = 'none';
        const i = document.getElementById('inputAjuste');
        i.style.display = 'block'; i.value = distTotal.toFixed(3); i.focus();
    };

    document.getElementById('inputAjuste').onblur = function() {
        const n = parseFloat(this.value);
        if (!isNaN(n) && n >= 0) { distTotal = n; atualizarDisplay(); }
        this.style.display = 'none'; document.getElementById('viewDist').style.display = 'block';
    };

    document.getElementById('btnP1').onclick = () => { distTotal += 0.001; atualizarDisplay(); };
    document.getElementById('btnM1').onclick = () => { if(distTotal > 0.001) distTotal -= 0.001; atualizarDisplay(); };
    document.getElementById('btnZerar').onclick = () => { if(confirm("Zerar?")) { distTotal = 0; atualizarDisplay(); } };
    
    document.getElementById('btnSair').onclick = () => {
        if(confirm("Encerrar Sessão?")) { 
            if(watchID) navigator.geolocation.clearWatch(watchID);
            localStorage.clear(); 
            location.reload(); 
        }
    };

    window.onload = () => {
        const logado = localStorage.getItem('rally_carro_ativo');
        if (logado) iniciarFluxoRastreio(logado);
    };
</script>
