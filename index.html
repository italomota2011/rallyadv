<script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        let wakeLock = null;
        let watchID = null;
        let ultimaPos = null;

        // 1. AJUSTE: LER O VALOR IMEDIATAMENTE
        let odoTotal = 0;
        const odoNoBancoLocal = localStorage.getItem('rally_odo_total');
        if (odoNoBancoLocal) {
            odoTotal = parseFloat(odoNoBancoLocal);
        }

        // Função para atualizar o visor e o banco local ao mesmo tempo
        function atualizarTelaOdo() { 
            const display = document.getElementById('displayOdo');
            if (display) {
                display.innerText = odoTotal.toFixed(3);
            }
            localStorage.setItem('rally_odo_total', odoTotal.toString()); 
        }

        // ... (Mantenha as funções solicitarWakeLock, ativarFallbackVideo e calcularDistancia iguais)

        function iniciarFluxoRastreio(num) {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('ativo').style.display = 'block';
            document.getElementById('viewCarro').innerText = "Carro " + num;
            
            // 2. AJUSTE: Garantir que ao entrar na tela de rastreio o valor apareça
            atualizarTelaOdo();
            solicitarWakeLock();

            db.ref(".info/connected").on("value", (snap) => {
                const msg = document.getElementById('msgGps');
                if (snap.val() === true) {
                    msg.innerText = "● TRANSMITINDO AO VIVO";
                    msg.classList.remove('status-offline');
                } else {
                    msg.innerText = "○ SEM SINAL DE INTERNET";
                    msg.classList.add('status-offline');
                }
            });

            watchID = navigator.geolocation.watchPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speedMS = position.coords.speed || 0;
                const kmh = Math.round(speedMS * 3.6);

                if (accuracy > 30) return;

                if (ultimaPos) {
                    const dist = calcularDistancia(ultimaPos.lat, ultimaPos.lng, lat, lng);
                    if (dist > 0.005) { 
                        odoTotal += dist;
                        atualizarTelaOdo();
                        ultimaPos = { lat, lng }; 
                    }
                } else {
                    ultimaPos = { lat, lng };
                }

                document.getElementById('viewVel').innerText = kmh.toFixed(1);
                const dados = { lat, lng, vel: kmh, acc: accuracy, ts: Date.now() };
                db.ref('posicoes/' + num).set(dados);
            }, (err) => { console.error(err); }, { enableHighAccuracy: true });
        }

        // 3. AJUSTE: O WINDOW.ONLOAD AGORA É MAIS "AGRESSIVO"
        window.onload = function() {
            // Tenta atualizar o visor assim que a página termina de desenhar
            atualizarTelaOdo();

            const salvo = localStorage.getItem('rally_carro_ativo');
            if (salvo) {
                iniciarFluxoRastreio(salvo);
            }
        };

        // ... (Mantenha o resto das funções: zerarOdo, alterarOdo, ajusteManualOdo, encerrarSessao iguais)
    </script>
