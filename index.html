<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Piloto - Rally</title>
    <style>
        body { font-family: sans-serif; background: #1a202c; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .box { background: #2d3748; padding: 25px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; text-align: center; }
        button { width: 100%; padding: 15px; border-radius: 5px; border: none; background: #ed8936; color: white; font-weight: bold; cursor: pointer; }
        #speed { font-size: 3em; color: #68d391; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="box">
        <h3>Transmissor de GPS</h3>
        <input type="number" id="carId" placeholder="NÂº do Carro">
        <input type="text" id="carName" placeholder="Nome do Piloto">
        <div id="speed">0 <small>km/h</small></div>
        <button id="btn" onclick="iniciar()">Iniciar Corrida</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function iniciar() {
            const id = document.getElementById('carId').value;
            const nome = document.getElementById('carName').value;
            if(!id || !nome) return alert("Preencha tudo!");

            document.getElementById('btn').disabled = true;
            document.getElementById('btn').innerText = "Transmitindo...";

            // Registra o competidor para ele aparecer nas listas
            db.ref('competidores/' + id).set({ nome: nome, pontos: 150000 });

            navigator.geolocation.watchPosition(pos => {
                const kmh = pos.coords.speed ? (pos.coords.speed * 3.6) : 0;
                document.getElementById('speed').innerHTML = Math.round(kmh) + " <small>km/h</small>";

                const dados = { lat: pos.coords.latitude, lng: pos.coords.longitude, vel: kmh, time: Date.now() };
                
                db.ref('posicoes/' + id).set(dados); // Para o mapa em tempo real
                db.ref('rastros/' + id).push(dados); // Para a auditoria de rastro
            }, err => console.error(err), { enableHighAccuracy: true });
        }
    </script>
</body>
</html>
