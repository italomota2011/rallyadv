<!DOCTYPE html>
<html>
<head>
    <title>Rally - Competidor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #speed { font-size: 3em; font-weight: bold; color: #007bff; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box;}
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>CARRO <span id="displayCar">--</span></h2>
    <input type="number" id="carNumber" placeholder="Nº do Carro (1-100)">
    <button id="btnStart" onclick="startRally()">INICIAR RASTREIO</button>
    <hr>
    <div>Velocidade Atual</div>
    <div id="speed">0</div>
    <div>km/h</div>
    <p id="status" style="color: gray;">GPS Inativo</p>
</div>

<script>
    const firebaseConfig = { /* Sua Configuração */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function startRally() {
        const carId = document.getElementById('carNumber').value;
        if(!carId || carId < 1 || carId > 100) return alert("Insira um número de 1 a 100");

        document.getElementById('displayCar').innerText = carId;
        document.getElementById('btnStart').disabled = true;
        document.getElementById('btnStart').style.background = "#ccc";
        document.getElementById('status').innerText = "Rastreando...";

        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(pos => {
                const speedKmH = pos.coords.speed ? (pos.coords.speed * 3.6) : 0;
                document.getElementById('speed').innerText = Math.round(speedKmH);

                const gpsData = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    speed: speedKmH,
                    time: Date.now()
                };

                // Envia para o mapa em tempo real
                db.ref('live_tracking/' + carId).set(gpsData);
                // Salva no rastro (histórico)
                db.ref('history/' + carId).push(gpsData);

            }, err => alert("Erro no GPS: " + err.message), 
            { enableHighAccuracy: true, maximumAge: 1000 });
        }
    }
</script>
</body>
</html>