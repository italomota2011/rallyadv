<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rally - Competidor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 20px; }
        input, select, button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 8px; border: none; }
        button { background: #e67e22; color: white; font-weight: bold; }
        .status { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Registro do Competidor</h2>
    <div id="registro">
        <input type="text" id="nome" placeholder="Nome do Piloto">
        <select id="categoria">
            <option>BAIANO 4x2</option><option>BAIANO 4x4</option>
            <option>INICIANTE 4x2</option><option>INICIANTE 4x4</option>
            <option>ANTIGOS</option>
        </select>
        <input type="number" id="carro" placeholder="Número do Carro (1-100)" min="1" max="100">
        <button onclick="iniciarRastreio()">INICIAR PROVA</button>
    </div>
    <div id="tracking" style="display:none">
        <h3>Rastreio Ativo</h3>
        <p>Carro: <span id="dispCarro"></span></p>
        <p class="status">ENVIANDO COORDENADAS...</p>
    </div>

    <script>
        const firebaseConfig = { /* SEUS DADOS AQUI */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function iniciarRastreio() {
            const num = document.getElementById('carro').value;
            const nome = document.getElementById('nome').value;
            const cat = document.getElementById('categoria').value;

            if(!num || !nome) return alert("Preencha tudo!");

            db.ref('competidores/' + num).once('value', snapshot => {
                if(snapshot.exists()) return alert("Carro já em uso!");

                db.ref('competidores/' + num).set({ nome, categoria, pontos: 150000 });
                document.getElementById('registro').style.display = 'none';
                document.getElementById('tracking').style.display = 'block';
                document.getElementById('dispCarro').innerText = num;

                navigator.geolocation.watchPosition(pos => {
                    const data = {
                        lat: pos.coords.latitude,
                        lng: pos.coords.longitude,
                        vel: (pos.coords.speed || 0) * 3.6, // km/h
                        timestamp: Date.now()
                    };
                    db.ref('posicoes/' + num).set(data);
                    db.ref('rastros/' + num).push(data);
                }, err => console.error(err), { enableHighAccuracy: true });
            });
        }
    </script>
</body>
</html>
