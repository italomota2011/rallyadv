<!DOCTYPE html>
<html>
<head>
    <title>Competidor - GPS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <h2>Registro do Competidor</h2>
    <div id="form">
        <input type="text" id="nome" placeholder="Seu Nome"><br>
        <input type="number" id="numero" placeholder="Nº do Carro (1-100)"><br>
        <select id="categoria">
            <option value="4x2">4x2</option>
            <option value="4x4">4x4</option>
        </select><br>
        <button onclick="iniciarRastreio()">Iniciar Corrida</button>
    </div>
    <p id="status"></p>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { /* MESMA CONFIG DO ADMIN */ };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        window.iniciarRastreio = () => {
            const num = document.getElementById('numero').value;
            const nome = document.getElementById('nome').value;
            const cat = document.getElementById('categoria').value;

            if(!num || num < 1 || num > 100) return alert("Número inválido");

            document.getElementById('form').style.display = 'none';
            document.getElementById('status').innerText = "Rastreando...";

            navigator.geolocation.watchPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                const vel = (pos.coords.speed || 0) * 3.6; // conv para km/h

                // Update Realtime
                set(ref(db, 'competidores/' + num), {
                    nome, numero: num, categoria: cat, lat, lng, vel, pontos: 150000
                });

                // Salva histórico para a página de rastro
                push(ref(db, 'historico/' + num), { lat, lng, vel, time: Date.now() });
                
            }, err => console.error(err), { enableHighAccuracy: true });
        };
    </script>
</body>
</html>
