<!DOCTYPE html>
<html>
<head>
    <title>Rally Competidor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        input, select, button { width: 100%; padding: 15px; margin: 10px 0; font-size: 16px; }
        #status { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Rally - GPS Competidor</h2>
    <div id="setup">
        <input type="text" id="driverName" placeholder="Nome do Piloto">
        <input type="number" id="carNumber" placeholder="Número do Carro (1-100)" min="1" max="100">
        <select id="category">
            <option value="4x2">Categoria 4x2</option>
            <option value="4x4">Categoria 4x4</option>
        </select>
        <button onclick="startTracking()">Iniciar Transmissão</button>
    </div>

    <div id="tracking" style="display:none;">
        <h3>Enviando Dados...</h3>
        <p id="displaySpeed">0 km/h</p>
        <div id="status">Conectado ao GPS</div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
        authDomain: "cronometro-rally.firebaseapp.com",
        databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
        projectId: "cronometro-rally"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.startTracking = () => {
        const carNum = document.getElementById('carNumber').value;
        const name = document.getElementById('driverName').value;
        const cat = document.getElementById('category').value;

        if(!carNum || !name) return alert("Preencha todos os campos");

        // Verifica se carro já existe
        onValue(ref(db, `cars/${carNum}`), (snapshot) => {
            if(snapshot.exists() && !window.isTracking) {
                alert("Este número de carro já está em uso!");
            } else {
                proceed(carNum, name, cat);
            }
        }, { onlyOnce: true });
    };

    function proceed(id, name, category) {
        window.isTracking = true;
        document.getElementById('setup').style.display = 'none';
        document.getElementById('tracking').style.display = 'block';

        navigator.geolocation.watchPosition((pos) => {
            const speedKmH = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;
            document.getElementById('displaySpeed').innerText = speedKmH + " km/h";

            set(ref(db, `cars/${id}`), {
                name: name,
                category: category,
                lat: pos.coords.latitude,
                lng: pos.coords.longitude,
                speed: speedKmH,
                timestamp: Date.now()
            });
        }, (err) => console.error(err), {
            enableHighAccuracy: true
        });
    }
</script>
</body>
</html>
