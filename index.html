<script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        let wakeLock = null;
        let watchID = null;
        let ultimaPos = null;

        // --- BLOCO DE RECUPERAÇÃO ULTRA-RÁPIDA ---
        // Lemos o valor antes de qualquer outra função existir
        let odoTotal = parseFloat(localStorage.getItem('rally_odo_total')) || 0;

        function atualizarTelaOdo() { 
            const display = document.getElementById('displayOdo');
            if (display) {
                display.innerText = odoTotal.toFixed(3);
            }
            // Salvamos como string para garantir que o navegador não se confunda
            localStorage.setItem('rally_odo_total', odoTotal.toString()); 
        }

        // --- FUNÇÕES DE CONTROLE ---
        function alterarOdo(v) { 
            odoTotal = Math.max(0, odoTotal + v); 
            atualizarTelaOdo(); 
        }

        function zerarOdo() { 
            if(confirm("Zerar odômetro?")) { 
                odoTotal = 0; 
                atualizarTelaOdo(); 
            } 
        }

        function ajusteManualOdo() {
            let n = prompt("Ajustar Odômetro (KM):", odoTotal.toFixed(3));
            if(n !== null) { 
                let val = parseFloat(n.replace(',','.'));
                if(!isNaN(val)) {
                    odoTotal = Math.max(0, val);
                    atualizarTelaOdo();
                }
            }
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        // --- GPS E TRANSMISSÃO ---
        function iniciarFluxoRastreio(num) {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('ativo').style.display = 'block';
            document.getElementById('viewCarro').innerText = "Carro " + num;
            
            // Força o valor salvo a aparecer na tela assim que o GPS liga
            atualizarTelaOdo();
            solicitarWakeLock();

            watchID = navigator.geolocation.watchPosition(position => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const speedMS = position.coords.speed || 0;
                const kmh = Math.round(speedMS * 3.6);

                if (accuracy > 30) return;

                if (ultimaPos) {
                    const dist = calcularDistancia(ultimaPos.lat, ultimaPos.lng, lat, lng);
                    if (dist > 0.002) { // 2 metros de movimento já conta
                        odoTotal += dist;
                        atualizarTelaOdo();
                        ultimaPos = { lat, lng }; 
                    }
                } else {
                    ultimaPos = { lat, lng };
                }

                document.getElementById('viewVel').innerText = kmh.toFixed(1);
                db.ref('posicoes/' + num).set({ lat, lng, vel: kmh, acc: accuracy, ts: Date.now() });
            }, (err) => { console.error(err); }, { enableHighAccuracy: true, maximumAge: 0 });
        }

        // --- INICIALIZAÇÃO AO CARREGAR PÁGINA ---
        window.onload = function() {
            // 1. Mostra o valor que está na memória imediatamente
            atualizarTelaOdo();

            // 2. Verifica se deve voltar para a tela de rastreio
            const salvo = localStorage.getItem('rally_carro_ativo');
            if (salvo) {
                iniciarFluxoRastreio(salvo);
            }
        };

        // WakeLock (Mantenha igual ao seu)
        async function solicitarWakeLock() {
            if ('wakeLock' in navigator) {
                try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}
            }
        }

        function encerrarSessao() {
            if(confirm("Encerrar prova? Isso limpará os dados do celular.")) {
                if (watchID) navigator.geolocation.clearWatch(watchID);
                localStorage.clear(); // Limpa TUDO
                location.reload();
            }
        }
    </script>
