<!DOCTYPE html>
<html>
<head>
    <title>Competidor - Rally</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        input, select, button { width: 100%; padding: 15px; margin: 10px 0; font-size: 1.2rem; }
        #status { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <h2>Registro do Piloto</h2>
    <div id="setup">
        <input type="text" id="nome" placeholder="Seu Nome">
        <input type="number" id="carroNum" placeholder="Número do Carro (1-100)" min="1" max="100">
        <select id="categoria">
            <option value="4x2">4x2</option>
            <option value="4x4">4x4</option>
        </select>
        <button onclick="iniciarRastreio()">Iniciar Corrida</button>
    </div>
    <div id="tracking" style="display:none;">
        <p id="status">Transmitindo Localização...</p>
        <h1 id="dispVel">0 km/h</h1>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script>
        const firebaseConfig = { /* SEU CONFIG AQUI */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function iniciarRastreio() {
            const num = document.getElementById('carroNum').value;
            const nome = document.getElementById('nome').value;
            const cat = document.getElementById('categoria').value;

            // Verificar se carro já existe
            db.ref('competidores/' + num).once('value', snap => {
                if (snap.exists()) return alert("Número já em uso!");

                document.getElementById('setup').style.display = 'none';
                document.getElementById('tracking').style.display = 'block';

                navigator.geolocation.watchPosition(pos => {
                    const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(0) : 0;
                    document.getElementById('dispVel').innerText = speed + " km/h";
                    
                    const update = {
                        nome: nome, numero: num, categoria: cat,
                        lat: pos.coords.latitude, lng: pos.coords.longitude,
                        velocidade: speed, pontos: 150000, timestamp: Date.now()
                    };
                    db.ref('competidores/' + num).update(update);
                    // Salvar rastro para a Parte 4
                    db.ref('rastros/' + num).push({lat: pos.coords.latitude, lng: pos.coords.longitude, vel: speed});
                }, err => console.error(err), { enableHighAccuracy: true });
            });
        }
    </script>
</body>
</html>
