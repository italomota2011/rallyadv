<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rally Tracker Pro</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#e67e22">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Rally Tracker">
    <link rel="apple-touch-icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s">
    <meta name="mobile-web-app-capable" content="yes">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    <style>
        body { font-family: sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
        .setup-container { width: 100%; max-width: 400px; text-align: center; }
        .logo { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #e67e22; margin-bottom: 20px; object-fit: cover; }
        h1 { margin: 0 0 20px 0; color: #e67e22; font-size: 24px; }
        input, select { width: 100%; padding: 15px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #333; background: #1e1e1e; color: white; font-size: 16px; box-sizing: border-box; }
        .btn-iniciar { background: #e67e22; color: white; border: none; padding: 18px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.3s; }
        .btn-iniciar:active { transform: scale(0.98); background: #d35400; }
        #viewDash { display: none; width: 100%; height: 100%; text-align: center; }
        .vel-display { font-size: 80px; font-weight: bold; color: #e67e22; margin: 20px 0; }
        .label-vel { color: #888; text-transform: uppercase; letter-spacing: 2px; }
        .status-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; background: #27ae60; font-size: 12px; margin-top: 10px; }
        .btn-encerrar { background: transparent; border: 1px solid #c0392b; color: #c0392b; padding: 10px 20px; border-radius: 5px; margin-top: 50px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="viewLogin" class="setup-container">
        <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRakETPU1WsKmBi2ppw7axi6RJ9ie0KAWookA&s" alt="Logo" class="logo">
        <h1>RALLY TRACKER</h1>
        <input type="text" id="nome" placeholder="Nome do Piloto" autocomplete="off">
        <input type="number" id="carro" placeholder="Número do Carro (1-100)" min="1" max="100">
        <select id="categoria">
            <option value="BAIANO 4x2">BAIANO 4x2</option>
            <option value="BAIANO 4x4">BAIANO 4x4</option>
            <option value="INICIANTE 4x2">INICIANTE 4x2</option>
            <option value="INICIANTE 4x4">INICIANTE 4x4</option>
            <option value="ANTIGOS">ANTIGOS</option>
        </select>
        <button class="btn-iniciar" id="btnIniciar" onclick="cadastrarEComecar()">INICIAR RASTREIO</button>
    </div>

    <div id="viewDash">
        <div class="label-vel">Velocidade Atual</div>
        <div class="vel-display"><span id="viewVel">0.0</span><small style="font-size: 20px;"> km/h</small></div>
        <div id="viewPiloto" style="font-size: 18px; color: #aaa;"></div>
        <div class="status-badge">● GPS ATIVO</div>
        <br>
        <button class="btn-encerrar" onclick="encerrarSessao()">ENCERRAR SESSÃO</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let watchID = null;
        let wakeLock = null;

        // Recuperar sessão ativa
        window.onload = () => {
            const salvo = localStorage.getItem('rally_carro_ativo');
            if(salvo) iniciarFluxoRastreio(salvo);
        };

        async function cadastrarEComecar() {
            const nomeRaw = document.getElementById('nome').value.trim();
            const cat = document.getElementById('categoria').value;
            const numRaw = document.getElementById('carro').value;
            const num = parseInt(numRaw);

            if(!nomeRaw || !numRaw) return alert("Preencha todos os campos!");
            if(num < 1 || num > 100) return alert("Número entre 1 e 100!");

            try {
                await db.ref('competidores/' + num).set({ nome: nomeRaw, categoria: cat, pontos: 0 });
                localStorage.setItem('rally_carro_ativo', num);
                iniciarFluxoRastreio(num);
            } catch (e) {
                alert("Erro ao conectar.");
            }
        }

        async function iniciarFluxoRastreio(num) {
            document.getElementById('viewLogin').style.display = 'none';
            document.getElementById('viewDash').style.display = 'block';
            
            db.ref('competidores/' + num).once('value', s => {
                document.getElementById('viewPiloto').innerText = `Carro ${num} - ${s.val().nome}`;
            });

            // Bloqueio de tela
            try { if ('wakeLock' in navigator) wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {}

            watchID = navigator.geolocation.watchPosition(pos => {
                const velRaw = (pos.coords.speed || 0) * 3.6;
                const velNum = parseFloat(velRaw.toFixed(1)); // GARANTE QUE É NÚMERO
                
                document.getElementById('viewVel').innerText = velNum.toFixed(1);
                
                const coord = { 
                    lat: pos.coords.latitude, 
                    lng: pos.coords.longitude, 
                    vel: velNum, 
                    ts: Date.now() 
                };

                db.ref('posicoes/' + num).set(coord);
                db.ref('rastros/' + num).push(coord);
                
            }, (err) => console.error(err), { enableHighAccuracy: true, maximumAge: 0 });
        }

        function encerrarSessao() {
            if(confirm("Encerrar sessão?")) {
                if (watchID) navigator.geolocation.clearWatch(watchID);
                localStorage.removeItem('rally_carro_ativo');
                location.reload();
            }
        }
    </script>
</body>
</html>
