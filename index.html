<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Competidor - Rally</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <script>
        // Declarar db no escopo global
        var db;

        // Configuração do seu Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            storageBucket: "cronometro-rally.firebasestorage.app",
            messagingSenderId: "341731891354",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };

        // Inicializar assim que o script for lido
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            console.log("Firebase pronto!");
        } catch (e) {
            console.error("Erro na inicialização:", e);
        }

        // DEFINIÇÃO DA FUNÇÃO (Garantindo que ela exista globalmente)
        window.validarEIniciar = function() {
            console.log("Botão clicado!"); // Para teste no console
            const num = document.getElementById('carroNum').value;
            const nome = document.getElementById('nome').value;
            const cat = document.getElementById('categoria').value;
            
            if (!num || !nome) {
                alert("Por favor, preencha todos os campos.");
                return;
            }

            // Verifica disponibilidade do número
            db.ref('competidores/' + num).once('value')
                .then((snap) => {
                    if (snap.exists()) {
                        alert("Este número de carro já está em uso!");
                    } else {
                        iniciarRastreio(num, nome, cat);
                    }
                })
                .catch((err) => {
                    console.error("Erro ao acessar banco:", err);
                    alert("Erro de conexão com o Banco de Dados. Verifique suas regras de segurança.");
                });
        };

        function iniciarRastreio(num, nome, cat) {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('tracking').style.display = 'block';
            document.getElementById('carInfo').innerText = `Piloto: ${nome} | Carro: ${num}`;

            navigator.geolocation.watchPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    const speed = pos.coords.speed ? Math.round(pos.coords.speed * 3.6) : 0;

                    document.getElementById('speed').innerText = speed;
                    document.getElementById('status').innerText = "✅ Transmitindo...";

                    // Update no Firebase
                    db.ref('competidores/' + num).set({
                        nome, numero: num, categoria: cat, lat, lng, velocidade: speed, pontos: 150000
                    });
                    
                    // Histórico para a Parte 4
                    db.ref('rastros/' + num).push({ lat, lng, vel: speed, t: Date.now() });
                },
                (err) => {
                    document.getElementById('status').innerText = "❌ Erro GPS: " + err.message;
                },
                { enableHighAccuracy: true }
            );
        }
    </script>

    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; background: #f4f7f6; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 350px; margin: auto; }
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 5px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #27ae60; color: white; font-weight: bold; border: none; cursor: pointer; }
        .vel-display { font-size: 60px; font-weight: bold; color: #2c3e50; }
    </style>
</head>
<body>

<div class="card">
    <div id="setup">
        <h3>Cadastro Rally</h3>
        <input type="text" id="nome" placeholder="Seu Nome">
        <input type="number" id="carroNum" placeholder="Nº Carro (1-100)">
        <select id="categoria">
            <option value="4x2">4x2</option>
            <option value="4x4">4x4</option>
        </select>
        <button onclick="validarEIniciar()">ENTRAR NA PROVA</button>
    </div>

    <div id="tracking" style="display:none;">
        <div class="vel-display" id="speed">0</div>
        <p>km/h</p>
        <p id="carInfo"></p>
        <div id="status">Buscando satélites...</div>
    </div>
</div>

</body>
</html>
