<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Ranking Geral - Rally</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a202c; color: white; padding: 20px; }
        .container { max-width: 900px; margin: auto; }
        .config-section { background: #2d3748; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #e67e22; }
        input[type="text"] { width: 100%; padding: 10px; margin-top: 5px; border-radius: 4px; border: none; background: #1a202c; color: white; }
        .cat-card { background: #2d3748; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { color: #e67e22; margin-top: 0; border-bottom: 1px solid #4a5568; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: #a0aec0; padding: 10px; border-bottom: 1px solid #4a5568; }
        td { padding: 12px; border-bottom: 1px solid #2d3748; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 12px 20px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; color: white; }
        .btn-pdf { background: #38a169; }
        .btn-voltar { background: #4a5568; }
    </style>
</head>
<body>

    <div class="container">
        <h2>üèÜ Classifica√ß√£o Oficial</h2>

        <div class="config-section">
            <label>Cidade / Nome da Etapa:</label>
            <input type="text" id="inputCidade" placeholder="Ex: Feira de Santana - BA">
        </div>

        <div class="btn-group">
            <button class="btn btn-voltar" onclick="location.href='admin.html'">VOLTAR</button>
            <button class="btn btn-pdf" onclick="exportarPDF()">EXPORTAR PDF</button>
        </div>

        <div id="rankingContent">Carregando resultados...</div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Lista de categorias oficiais do seu sistema
        const categorias = ["BAIANO 4x2", "BAIANO 4x4", "INICIANTE 4x2", "INICIANTE 4x4", "ANTIGOS"];

        db.ref('competidores').on('value', snap => {
            const data = snap.val();
            if(!data) {
                document.getElementById('rankingContent').innerHTML = "Nenhum dado encontrado.";
                return;
            }

            let html = "";
            categorias.forEach(cat => {
                let list = [];
                for(let id in data) {
                    if(data[id].categoria === cat) {
                        list.push({ id, ...data[id] });
                    }
                }

                // Ordena√ß√£o: Maior pontua√ß√£o primeiro
                list.sort((a, b) => (b.pontos || 0) - (a.pontos || 0));

                if(list.length > 0) {
                    html += `
                    <div class="cat-card">
                        <h2>${cat}</h2>
                        <table class="tabela-categoria">
                            <thead>
                                <tr>
                                    <th>Pos</th>
                                    <th>N¬∫</th>
                                    <th>Piloto</th>
                                    <th>Total Pontos</th>
                                </tr>
                            </thead>
                            <tbody>`;
                    
                    list.forEach((p, i) => {
                        html += `
                        <tr>
                            <td>${i + 1}¬∫</td>
                            <td><b>${p.id}</b></td>
                            <td>${p.nome}</td>
                            <td>${(p.pontos || 0).toLocaleString('pt-BR')}</td>
                        </tr>`;
                    });

                    html += `</tbody></table></div>`;
                }
            });

            document.getElementById('rankingContent').innerHTML = html || "Aguardando processamento dos pontos...";
        });

        async function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const cidade = document.getElementById('inputCidade').value || "Resultado Oficial";

            doc.setFontSize(18);
            doc.text("RANKING GERAL - RALLY", 105, 15, { align: "center" });
            doc.setFontSize(12);
            doc.text(cidade, 105, 22, { align: "center" });

            let yPos = 30;

            // Busca todas as tabelas geradas na tela
            const tabelas = document.querySelectorAll('.cat-card');
            
            tabelas.forEach((card, index) => {
                const titulo = card.querySelector('h2').innerText;
                const tabelaData = card.querySelector('table');

                doc.setFontSize(14);
                doc.text(titulo, 14, yPos);

                doc.autoTable({
                    html: tabelaData,
                    startY: yPos + 5,
                    theme: 'striped',
                    headStyles: { fillColor: [230, 126, 34] },
                    didDrawPage: (data) => { yPos = data.cursor.y + 15; }
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
            });

            doc.save(`Ranking_${cidade.replace(/\s+/g, '_')}.pdf`);
        }
    </script>
</body>
</html>
