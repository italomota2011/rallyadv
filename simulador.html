<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Simulador Rally - Controle Final</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 50px; background: #2c3e50; color: white; }
        .card { background: white; color: #333; padding: 40px; border-radius: 15px; display: inline-block; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .btn { padding: 15px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1.2em; color: white; transition: 0.3s; width: 250px; }
        .btn-stop { background: #c0392b; }
        .btn-start { background: #27ae60; }
        #status-display { margin-top: 20px; font-weight: bold; font-size: 1.1em; }
    </style>
</head>
<body>

    <div class="card">
        <h2>Controle da Transmissão</h2>
        <p>100 Carros Simultâneos</p>
        
        <button id="toggleBtn" class="btn btn-stop" onclick="toggleSimulation()">Parar Simulação</button>
        
        <div id="status-display" style="color: #27ae60;">● Transmitindo em tempo real</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let simulationInterval = null; // Variável global para o controle
        let isRunning = false;

        function transmitir() {
            const updates = {};
            const latBase = -23.5505;
            const lngBase = -46.6333;
            const now = Date.now();

            for (let i = 1; i <= 100; i++) {
                const lat = latBase + (Math.random() - 0.5) * 0.05;
                const lng = lngBase + (Math.random() - 0.5) * 0.05;
                const vel = Math.floor(Math.random() * 110);
                
                const path = 'prova/carros/carro_' + i;
                updates[path + '/id'] = i;
                updates[path + '/lat'] = lat;
                updates[path + '/lng'] = lng;
                updates[path + '/velocidade'] = vel;

                // Salva histórico para o rastro ler
                db.ref(path + '/historico').push({ lat, lng, vel, t: now });
            }
            db.ref().update(updates);
            console.log("Pacote de 100 carros enviado.");
        }

        function toggleSimulation() {
            const btn = document.getElementById('toggleBtn');
            const status = document.getElementById('status-display');

            if (isRunning) {
                // PARAR
                clearInterval(simulationInterval);
                simulationInterval = null;
                isRunning = false;
                btn.innerHTML = "Iniciar Simulação";
                btn.className = "btn btn-start";
                status.innerHTML = "○ Simulação Parada";
                status.style.color = "#c0392b";
            } else {
                // INICIAR
                transmitir(); // Envia o primeiro imediatamente
                simulationInterval = setInterval(transmitir, 3000);
                isRunning = true;
                btn.innerHTML = "Parar Simulação";
                btn.className = "btn btn-stop";
                status.innerHTML = "● Transmitindo em tempo real";
                status.style.color = "#27ae60";
            }
        }

        // Inicia automaticamente ao abrir a página
        toggleSimulation();
    </script>
</body>
</html>
