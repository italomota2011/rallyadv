<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Simulador Rally - Controle e Trajeto</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { background: #2c3e50; color: white; padding: 15px; display: flex; gap: 20px; align-items: center; z-index: 1000; flex-wrap: wrap; }
        #map { flex-grow: 1; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; color: white; }
        .btn-stop { background: #c0392b; }
        .btn-start { background: #27ae60; }
        select { padding: 8px; border-radius: 4px; }
        .status-indicator { display: flex; align-items: center; gap: 5px; font-size: 0.9em; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

<header id="header">
    <div class="status-indicator">
        <span id="status-dot" class="dot" style="background: #27ae60;"></span>
        <span id="status-text">Simulação Ativa</span>
    </div>

    <button id="toggleBtn" class="btn btn-stop" onclick="toggleSimulation()">Parar Simulação</button>

    <div style="border-left: 1px solid #555; padding-left: 20px;">
        <label>Ver Trajeto do Carro:</label>
        <select id="carSelector" onchange="visualizarTrajeto()">
            <option value="">Selecione um carro...</option>
        </select>
    </div>
    
    <span style="font-size: 0.8em; color: #bdc3c7;">* O trajeto é lido do histórico do Firebase</span>
</header>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
        authDomain: "cronometro-rally.firebaseapp.com",
        databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
        projectId: "cronometro-rally",
        storageBucket: "cronometro-rally.firebasestorage.app",
        messagingSenderId: "341731891354",
        appId: "1:341731891354:web:d0c34265be68015e98a723"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map').setView([-23.5505, -46.6333], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let simulationInterval = null;
    let isRunning = false;
    let polylineTrajeto = L.polyline([], {color: 'blue', weight: 4, opacity: 0.7}).addTo(map);
    const carMarkers = {};

    // Preencher seletor com 100 carros
    const selector = document.getElementById('carSelector');
    for(let i=1; i<=100; i++) {
        let opt = document.createElement('option');
        opt.value = i;
        opt.innerHTML = "Carro " + i;
        selector.appendChild(opt);
    }

    function toggleSimulation() {
        const btn = document.getElementById('toggleBtn');
        const dot = document.getElementById('status-dot');
        const txt = document.getElementById('status-text');

        if(isRunning) {
            clearInterval(simulationInterval);
            isRunning = false;
            btn.innerHTML = "Iniciar Simulação";
            btn.className = "btn btn-start";
            dot.style.background = "#c0392b";
            txt.innerHTML = "Simulação Parada";
        } else {
            simulationInterval = setInterval(transmitirDados, 3000);
            isRunning = true;
            btn.innerHTML = "Parar Simulação";
            btn.className = "btn btn-stop";
            dot.style.background = "#27ae60";
            txt.innerHTML = "Simulação Ativa";
            transmitirDados();
        }
    }

    function transmitirDados() {
        const updates = {};
        const latBase = -23.5505;
        const lngBase = -46.6333;

        for (let i = 1; i <= 100; i++) {
            const lat = latBase + (Math.random() - 0.5) * 0.05;
            const lng = lngBase + (Math.random() - 0.5) * 0.05;
            const vel = Math.floor(Math.random() * 110);
            
            updates['prova/carros/carro_'
