<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Auditoria de Rastro - Rally Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #2c3e50; color: white; padding: 15px; display: flex; align-items: center; gap: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #map { flex-grow: 1; width: 100%; }
        select, button { padding: 10px; border-radius: 4px; border: none; font-size: 14px; }
        button { background: #3498db; color: white; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }
        .info-box { background: white; padding: 10px; border-radius: 5px; position: absolute; bottom: 20px; left: 20px; z-index: 1000; box-shadow: 0 0 10px rgba(0,0,0,0.3); }
        .legend { display: flex; gap: 10px; align-items: center; font-size: 12px; margin-top: 5px; }
        .dot { height: 10px; width: 10px; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

<div class="header">
    <strong>Auditoria de Percurso</strong>
    <select id="carSelect">
        <option value="">Selecione um Carro (1-100)</option>
        </select>
    <button onclick="carregarRastro()">Visualizar Rastro</button>
    <span id="statusTxt"></span>
</div>

<div id="map"></div>

<div class="info-box">
    <strong>Legenda de Velocidade:</strong>
    <div class="legend"><span class="dot" style="background: #27ae60;"></span> Baixa (< 40km/h)</div>
    <div class="legend"><span class="dot" style="background: #f1c40f;"></span> Média (40-80km/h)</div>
    <div class="legend"><span class="dot" style="background: #e74c3c;"></span> Alta (> 80km/h)</div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // Configuração Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
        authDomain: "cronometro-rally.firebaseapp.com",
        databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
        projectId: "cronometro-rally",
        storageBucket: "cronometro-rally.firebasestorage.app",
        messagingSenderId: "341731891354",
        appId: "1:341731891354:web:d0c34265be68015e98a723"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Inicializar Mapa
    const map = L.map('map').setView([-23.55, -46.63], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Preencher o select com 100 carros
    const select = document.getElementById('carSelect');
    for(let i=1; i<=100; i++) {
        let opt = document.createElement('option');
        opt.value = i;
        opt.innerHTML = "Carro " + i;
        select.appendChild(opt);
    }

    let rastroLayer = L.featureGroup().addTo(map);

    async function carregarRastro() {
        const numCarro = select.value;
        if(!numCarro) return alert("Selecione um número!");

        document.getElementById('statusTxt').innerText = "Carregando dados...";
        rastroLayer.clearLayers();

        db.ref('rastros/' + numCarro).once('value', snapshot => {
            if(!snapshot.exists()) {
                document.getElementById('statusTxt').innerText = "Nenhum dado encontrado para este carro.";
                return;
            }

            const pontos = [];
            snapshot.forEach(child => {
                const p = child.val();
                pontos.push(p);
                
                // Determinar cor baseada na velocidade registrada no ponto
                let cor = "#27ae60";
                if(p.vel > 40) cor = "#f1c40f";
                if(p.vel > 80) cor = "#e74c3c";

                // Adicionar círculo pequeno para cada medição
                L.circleMarker([p.lat, p.lng], {
                    radius: 3,
                    color: cor,
                    fillOpacity: 0.8
                }).addTo(rastroLayer).bindPopup(`Vel: ${p.vel} km/h`);
            });

            // Desenhar a linha conectando os pontos
            const latlngs = pontos.map(p => [p.lat, p.lng]);
            const polyline = L.polyline(latlngs, {color: '#2c3e50', weight: 2, opacity: 0.5}).addTo(rastroLayer);
            
            // Ajustar o zoom para mostrar todo o rastro
            map.fitBounds(polyline.getBounds());
            document.getElementById('statusTxt').innerText = `Mostrando ${pontos.length} pontos de localização.`;
        });
    }
</script>
</body>
</html>