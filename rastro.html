<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rastro Rally - Analisador Final</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #121212; color: white; }
        #sidebar { width: 320px; background: #1e1e1e; padding: 20px; z-index: 1000; overflow-y: auto; }
        #map { flex-grow: 1; }
        h2 { color: #e67e22; margin-top: 0; }
        select, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: none; font-size: 16px; }
        select { background: #333; color: white; }
        button { background: #e67e22; color: white; font-weight: bold; cursor: pointer; }
        #details { background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22; font-size: 13px; line-height: 1.5; }
        .radar-label { color: #3498db !important; font-weight: bold; font-size: 11px; text-shadow: 1px 1px #000; background: none !important; border: none !important; box-shadow: none !important; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>üõ∞Ô∏è Analisador</h2>
        <label>Competidor:</label>
        <select id="carSelect"><option value="">Carregando...</option></select>
        <button onclick="drawTrack()">ANALISAR TRAJETO</button>
        <div id="details">Selecione um carro para ver o rastro e radares.</div>
        <button style="background:#555; margin-top:20px;" onclick="location.href='admin.html'">VOLTAR</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            storageBucket: "cronometro-rally.firebasestorage.app",
            messagingSenderId: "341731891354",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        const map = L.map('map').setView([-12.26, -38.96], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        let trackLayer = L.layerGroup().addTo(map);
        let routeLayer = L.layerGroup().addTo(map);
        let percursoOficial = null;

        // 1. Carregar Percurso com Prote√ß√£o contra GeoJSON Inv√°lido
        db.ref('configuracoes/percurso').on('value', snap => {
            const data = snap.val();
            if(!data || !data.features) return;
            percursoOficial = data;
            routeLayer.clearLayers();

            data.features.forEach(feature => {
                try {
                    L.geoJSON(feature, {
                        style: { color: "#3498db", weight: 2, fillOpacity: 0.1 },
                        pointToLayer: (f, latlng) => {
                            // Se for um c√≠rculo salvo como ponto com propriedade de raio
                            if (f.properties && f.properties.type === 'circle') {
                                return L.circle(latlng, { radius: f.properties.radius });
                            }
                        },
                        onEachFeature: (f, l) => {
                            if(f.properties && f.properties.velocidade) {
                                l.bindTooltip(`${f.properties.velocidade} km/h`, { 
                                    permanent: true, direction: 'center', className: 'radar-label' 
                                });
                            }
                        }
                    }).addTo(routeLayer);
                } catch (e) {
                    console.warn("Pulando fei√ß√£o inv√°lida:", feature, e);
                }
            });
        });

        // 2. Carregar Lista de Competidores
        db.ref('competidores').on('value', snap => {
            const select = document.getElementById('carSelect');
            let html = '<option value="">Selecione um carro...</option>';
            snap.forEach(child => {
                html += `<option value="${child.key}">Carro ${child.key} - ${child.val().nome}</option>`;
            });
            select.innerHTML = html;
        });

        // 3. Desenhar Trajeto e Penaliza√ß√µes
        async function drawTrack() {
            const id = document.getElementById('carSelect').value;
            if(!id) return;

            const snap = await db.ref('rastros/' + id).once('value');
            if(!snap.exists()) return alert("Sem rastro dispon√≠vel.");

            trackLayer.clearLayers();
            const pontos = Object.values(snap.val()).sort((a, b) => a.ts - b.ts);
            const coords = pontos.map(p => [p.lat, p.lng]);

            const poly = L.polyline(coords, {color: '#e67e22', weight: 4}).addTo(trackLayer);
            
            let infracoes = 0;
            if(percursoOficial && percursoOficial.features) {
                pontos.forEach(p => {
                    const pt = turf.point([p.lng, p.lat]);
                    percursoOficial.features.forEach(feat => {
                        // Verifica se o ponto est√° dentro do pol√≠gono ou do raio do c√≠rculo
                        let dentro = false;
                        if (feat.geometry.type === 'Polygon') {
                            dentro = turf.booleanPointInPolygon(pt, feat);
                        } else if (feat.properties.type === 'circle') {
                            const center = [feat.geometry.coordinates[1], feat.geometry.coordinates[0]];
                            const distance = map.distance([p.lat, p.lng], center);
                            if (distance <= feat.properties.radius) dentro = true;
                        }

                        if(dentro) {
                            const limite = parseFloat(feat.properties.velocidade) || 60;
                            if(p.vel > limite) {
                                infracoes++;
                                L.circleMarker([p.lat, p.lng], {
                                    radius: 5, fillColor: "red", color: "white", weight: 2, fillOpacity: 1
                                }).bindPopup(`Excesso: ${p.vel.toFixed(1)} km/h`).addTo(trackLayer);
                            }
                        }
                    });
                });
            }

            map.fitBounds(poly.getBounds());
            document.getElementById('details').innerHTML = `
                <b>Carro ${id}:</b><br>
                Pontos de GPS: ${pontos.length}<br>
                <b style="color:#ff4757">Infra√ß√µes: ${infracoes}</b>
            `;
        }
    </script>
</body>
</html>
