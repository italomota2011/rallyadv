<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rally - Auditoria de Rastro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        #sidebar { width: 300px; background: #2c3e50; color: white; padding: 15px; overflow-y: auto; }
        #map { flex-grow: 1; }
        .info-card { background: #34495e; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9em; }
        select, button { width: 100%; padding: 10px; margin: 10px 0; border-radius: 4px; border: none; }
        button { background: #e67e22; color: white; cursor: pointer; }
        .penalidade { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>üßê Auditoria</h2>
        <label>Selecione o Carro:</label>
        <select id="selectCarro">
            <option value="">Escolha...</option>
        </select>
        <button onclick="analisarRastro()">Verificar Rastro</button>
        <hr>
        <div id="detalhes-auditoria">
            <p>Selecione um carro para ver o relat√≥rio de penalidades.</p>
        </div>
    </div>
    <div id="map"></div>

    <script>
        const firebaseConfig = { /* USE SEU CONFIG AQUI */ };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const map = L.map('map').setView([-12.266, -38.966], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let percursoLayer = L.geoJSON(null, {style: {color: 'gray', dashArray: '5, 5'}}).addTo(map);
        let rastroLayer = L.polyline([], {color: 'blue'}).addTo(map);

        // Popular Select de Carros
        db.ref('competidores').once('value', snapshot => {
            const select = document.getElementById('selectCarro');
            snapshot.forEach(child => {
                let opt = document.createElement('option');
                opt.value = child.key;
                opt.innerHTML = `Carro ${child.key} - ${child.val().nome}`;
                select.appendChild(opt);
            });
        });

        async function analisarRastro() {
            const idCarro = document.getElementById('selectCarro').value;
            if(!idCarro) return;

            // Limpar Mapa
            rastroLayer.setLatLngs([]);
            const detalhes = document.getElementById('detalhes-auditoria');
            detalhes.innerHTML = "Analisando dados...";

            // 1. Obter Percurso/Radares
            const configSnap = await db.ref('configuracoes/percurso').once('value');
            const percursoGeoJSON = configSnap.val();
            if(percursoGeoJSON) percursoLayer.clearLayers().addData(percursoGeoJSON);

            // 2. Obter Rastro do Carro
            db.ref('rastros/' + idCarro).once('value', snapshot => {
                const pontos = [];
                let infra√ß√µes = 0;
                let waypointsVisitados = new Set();
                
                snapshot.forEach(p => {
                    const data = p.val();
                    const pt = [data.lat, data.lng];
                    pontos.push(pt);

                    // L√≥gica de Detec√ß√£o de Radar (Simplificada)
                    if(percursoGeoJSON) {
                        percursoGeoJSON.features.forEach(feature => {
                            const point = turf.point([data.lng, data.lat]);
                            
                            // Verificar Radares (Pol√≠gonos)
                            if(feature.geometry.type === 'Polygon') {
                                if(turf.booleanPointInPolygon(point, feature)) {
                                    const velLimite = feature.properties.velocidade || 60;
                                    if(data.vel > velLimite) infra√ß√µes++;
                                }
                            }
                        });
                    }
                });

                rastroLayer.setLatLngs(pontos);
                map.fitBounds(rastroLayer.getBounds());

                detalhes.innerHTML = `
                    <div class="info-card">
                        <b>Resultado Carro ${idCarro}:</b><br>
                        Infra√ß√µes Radar: ${infra√ß√µes}<br>
                        <span class="penalidade">Total Perdido: -${infra√ß√µes * 10000} pts</span>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
