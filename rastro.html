<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Auditoria de Rastro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #1a202c; color: white; }
        #side { width: 350px; background: #2d3748; padding: 20px; overflow-y: auto; }
        #map { flex-grow: 1; }
        select, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .item { background: #1a202c; padding: 10px; margin-top: 10px; border-radius: 5px; border-left: 5px solid #4a5568; }
        .perigo { border-left-color: #f56565; color: #f56565; }
        .sucesso { border-left-color: #48bb78; color: #48bb78; }
    </style>
</head>
<body>
    <div id="side">
        <h3>üîç Auditoria</h3>
        <select id="carSelect"><option>Carregando pilotos...</option></select>
        <button onclick="analisar()" style="background: #ed8936;">Ver Trajeto</button>
        <button onclick="window.location.href='admin.html'" style="background: #4a5568;">Voltar</button>
        <div id="log"></div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let map, trackGroup, percursoLayer;

        window.onload = () => {
            map = L.map('map').setView([-12.26, -38.96], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            trackGroup = L.featureGroup().addTo(map);
            percursoLayer = L.geoJSON(null, {
                style: (f) => ({ color: f.geometry.type === 'Polygon' ? '#f56565' : '#4299e1', fillOpacity: 0.2 }),
                pointToLayer: (f, latlng) => L.circle(latlng, {radius: f.properties.radius, color: '#ed8936'})
            }).addTo(map);

            // Carrega lista de competidores
            db.ref('competidores').on('value', snap => {
                const s = document.getElementById('carSelect');
                s.innerHTML = '<option value="">Selecione um Piloto</option>';
                snap.forEach(c => s.innerHTML += `<option value="${c.key}">${c.key} - ${c.val().nome}</option>`);
            });
        };

        async function analisar() {
            const id = document.getElementById('carSelect').value;
            if(!id) return;

            const percurso = (await db.ref('configuracoes/percurso').once('value')).val();
            const rastro = (await db.ref('rastros/' + id).once('value')).val();
            
            if(!percurso || !rastro) return alert("Dados insuficientes!");

            trackGroup.clearLayers();
            percursoLayer.clearLayers();
            percursoLayer.addData(percurso);

            const rastroArr = Object.values(rastro);
            let logHtml = "<strong>Relat√≥rio:</strong><br>";

            // Desenha rastro ponto a ponto com cores
            for(let i=0; i < rastroArr.length - 1; i++) {
                const p1 = rastroArr[i];
                const p2 = rastroArr[i+1];
                let cor = "#48bb78"; // Verde

                // Verifica se o ponto 1 est√° em excesso dentro de algum radar
                const pt = turf.point([p1.lng, p1.lat], {vel: p1.vel});
                percurso.features.forEach(feat => {
                    if(feat.geometry.type === 'Polygon') {
                        const limite = feat.properties.velocidade || 60;
                        if(turf.booleanPointInPolygon(pt, feat) && p1.vel > limite) cor = "#f56565"; // Vermelho
                    }
                });

                L.polyline([[p1.lat, p1.lng], [p2.lat, p2.lng]], {color: cor, weight: 4}).addTo(trackGroup);
            }
            map.fitBounds(trackGroup.getBounds());
            document.getElementById('log').innerHTML = "Trajeto carregado. Verifique as cores no mapa.";
        }
    </script>
</body>
</html>
