<!DOCTYPE html>
<html>
<head>
    <title>Rastro Individual</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>#map { height: 80vh; }</style>
</head>
<body>
    <input type="number" id="carNum" placeholder="NÂº do Carro">
    <button onclick="carregarRastro()">Analisar Percurso</button>
    <div id="map"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const app = initializeApp({ /* CONFIG */ });
        const db = getDatabase(app);
        const map = L.map('map').setView([-23.55, -46.63], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        window.carregarRastro = async () => {
            const num = document.getElementById('carNum').value;
            const snap = await get(ref(db, `historico/${num}`));
            if(!snap.exists()) return alert("Sem dados para este carro");

            const pontos = Object.values(snap.val());
            const latlngs = pontos.map(p => [p.lat, p.lng]);
            
            // Desenha linha do rastro
            L.polyline(latlngs, {color: 'blue', weight: 3}).addTo(map);
            
            // Adiciona pontos de alerta onde houve velocidade alta
            pontos.forEach(p => {
                if(p.vel > 60) { // Exemplo: marca pontos acima de 60km/h
                    L.circleMarker([p.lat, p.lng], {radius: 3, color: 'red'}).addTo(map)
                     .bindPopup(`Velocidade: ${p.vel.toFixed(1)} km/h`);
                }
            });
            map.fitBounds(latlngs);
        };
    </script>
</body>
</html>
