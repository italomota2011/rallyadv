<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rastro Rally - Auditoria</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #121212; color: white; }
        #sidebar { width: 320px; background: #1e1e1e; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        #map { flex-grow: 1; background: #242424; }
        h2 { color: #e67e22; margin-top: 0; font-size: 18px; }
        select, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: none; font-size: 14px; }
        select { background: #333; color: white; }
        button { background: #e67e22; color: white; font-weight: bold; cursor: pointer; }
        #details { background: #252525; padding: 15px; border-radius: 8px; font-size: 13px; line-height: 1.6; border-left: 4px solid #e67e22; }
        .infracao { color: #ff4d4d; font-weight: bold; display: block; margin-top: 5px; }
        .ok { color: #2ecc71; font-weight: bold; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>üßê Auditoria de Rastro</h2>
        <p style="font-size: 12px; color: #888;">Selecione um carro para ver o trajeto e poss√≠veis infra√ß√µes.</p>
        
        <select id="carSelect">
            <option value="">Carregando competidores...</option>
        </select>
        
        <button onclick="drawTrack()">üîç Visualizar Trajeto</button>
        <button onclick="window.location.href='admin.html'" style="background: #444;">‚¨ÖÔ∏è Voltar ao Admin</button>

        <div id="details">Selecione um ve√≠culo para ver os detalhes da prova.</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            storageBucket: "cronometro-rally.firebasestorage.app",
            messagingSenderId: "341731891354",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        let map, poly, percursoLayer;

        window.onload = function() {
            map = L.map('map').setView([-12.26, -38.96], 13);
            
            const ruas = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const satelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
            
            L.control.layers({"Mapa": ruas, "Sat√©lite": satelite}).addTo(map);

            poly = L.polyline([], {color: '#805ad5', weight: 4, opacity: 0.8}).addTo(map);
            percursoLayer = L.geoJSON(null, {
                style: (f) => ({ color: f.geometry.type === 'Polygon' ? '#ff4d4d' : '#3182ce', fillOpacity: 0.2 }),
                pointToLayer: (f, latlng) => f.properties.type === 'circle' ? L.circle(latlng, {radius: f.properties.radius, color: '#ed8936'}) : null
            }).addTo(map);

            carregarCompetidores();
        };

        function carregarCompetidores() {
            db.ref('competidores').on('value', snap => {
                const select = document.getElementById('carSelect');
                let html = '<option value="">Selecione o Carro</option>';
                snap.forEach(c => {
                    html += `<option value="${c.key}">Carro ${c.key} - ${c.val().nome}</option>`;
                });
                select.innerHTML = html;
            });
        }

        async function drawTrack() {
            const id = document.getElementById('carSelect').value;
            if(!id) return;

            const percursoSnap = await db.ref('configuracoes/percurso').once('value');
            const rastroSnap = await db.ref('rastros/' + id).once('value');
            
            if(!percursoSnap.exists()) return alert("Trajeto oficial n√£o definido no Admin.");
            
            const percurso = percursoSnap.val();
            percursoLayer.clearLayers();
            percursoLayer.addData(percurso);

            if(!rastroSnap.exists()) {
                poly.setLatLngs([]);
                document.getElementById('details').innerHTML = "Nenhum rastro encontrado para este carro.";
                return;
            }

            const
