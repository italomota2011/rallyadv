<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rastro Rally - Tempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; }
        #map { height: 100vh; width: 100%; }
        #info-box {
            position: absolute; top: 10px; left: 50px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); padding: 15px;
            border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            font-family: sans-serif;
        }
        /* Ícone redondo com número do carro */
        .car-icon {
            background: #2980b9; color: white; border: 2px solid white;
            border-radius: 50%; text-align: center; line-height: 26px;
            font-weight: bold; font-size: 11px; width: 26px !important; height: 26px !important;
        }
    </style>
</head>
<body>

<div id="info-box">
    <strong>Monitoramento Rally</strong><br>
    Carros Online: <span id="count">0</span>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    // 1. Sua Configuração Exata
    const firebaseConfig = {
        apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
        authDomain: "cronometro-rally.firebaseapp.com",
        databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
        projectId: "cronometro-rally",
        storageBucket: "cronometro-rally.firebasestorage.app",
        messagingSenderId: "341731891354",
        appId: "1:341731891354:web:d0c34265be68015e98a723"
    };

    // 2. Inicialização
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 3. Configuração do Mapa
    const map = L.map('map').setView([-23.5505, -46.6333], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const markers = {};
    let focado = false;

    // 4. Ouvir dados do Firebase
    db.ref('prova/carros').on('value', (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        let total = 0;
        
        for (let key in data) {
            const c = data[key];
            if (c.lat && c.lng) {
                total++;
                const pos = [c.lat, c.lng];

                // Centraliza o mapa no primeiro carro que aparecer
                if (!focado) {
                    map.setView(pos, 13);
                    focado = true;
                }

                if (markers[key]) {
                    // Atualiza marcador existente
                    markers[key].setLatLng(pos);
                    markers[key].getPopup().setContent(`Carro ${c.id}<br>Velocidade: ${c.velocidade} km/h`);
                } else {
                    // Cria novo marcador com ícone numerado
                    const icon = L.divIcon({
                        className: 'car-icon',
                        html: c.id
                    });

                    markers[key] = L.marker(pos, { icon: icon })
                        .addTo(map)
                        .bindPopup(`Carro ${c.id}<br>Velocidade: ${c.velocidade} km/h`);
                }
            }
        }
        document.getElementById('count').innerText = total;
    }, (error) => {
        console.error("Erro ao ler Firebase:", error);
    });
</script>

</body>
</html>
