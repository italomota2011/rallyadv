<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Auditoria de Rastro - Rally</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #1a202c; color: white; }
        #sidebar { width: 350px; background: #2d3748; padding: 20px; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.3); z-index: 1000; }
        #map { flex-grow: 1; }
        h2 { color: #f6ad55; margin-top: 0; border-bottom: 2px solid #4a5568; padding-bottom: 10px; }
        select, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 6px; border: none; font-weight: bold; }
        select { background: #1a202c; color: white; cursor: pointer; }
        button { background: #ed8936; color: white; cursor: pointer; transition: 0.2s; }
        button:hover { background: #dd6b20; }
        #details { margin-top: 20px; background: #1a202c; padding: 15px; border-radius: 8px; flex-grow: 1; overflow-y: auto; font-size: 13px; border-left: 4px solid #ed8936; }
        .infracao { color: #fc8181; font-weight: bold; display: block; margin-bottom: 8px; padding: 5px; background: rgba(252, 129, 129, 0.1); border-radius: 4px; }
        .ok { color: #68d391; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>üßê Auditoria</h2>
        <label>Selecione o Competidor:</label>
        <select id="carSelect"><option>Carregando...</option></select>
        
        <button onclick="visualizarRastro()">üîç Analisar Rastro</button>
        <button onclick="window.location.href='admin.html'" style="background: #4a5568;">‚¨ÖÔ∏è Voltar ao Painel</button>

        <div id="details">Selecione um carro para processar o relat√≥rio de pista.</div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            storageBucket: "cronometro-rally.firebasestorage.app",
            messagingSenderId: "341731891354",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let map, rastroPoly, camadaPercurso;

        window.onload = function() {
            map = L.map('map').setView([-12.26, -38.96], 13);
            const ruas = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const sat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
            L.control.layers({"Mapa": ruas, "Sat√©lite": sat}).addTo(map);

            rastroPoly = L.polyline([], {color: '#b794f4', weight: 5, opacity: 0.8}).addTo(map);
            camadaPercurso = L.geoJSON(null, {
                style: (f) => ({ color: f.geometry.type === 'Polygon' ? '#f56565' : '#4299e1', fillOpacity: 0.3 }),
                pointToLayer: (f, latlng) => f.properties.type === 'circle' ? L.circle(latlng, {radius: f.properties.radius, color: '#ed8936'}) : null
            }).addTo(map);

            carregarLista();
        };

        function carregarLista() {
            db.ref('competidores').on('value', snap => {
                const select = document.getElementById('carSelect');
                select.innerHTML = '<option value="">Escolha um piloto</option>';
                snap.forEach(c => {
                    select.innerHTML += `<option value="${c.key}">ID: ${c.key} - ${c.val().nome}</option>`;
                });
            });
        }

        async function visualizarRastro() {
            const id = document.getElementById('carSelect').value;
            if(!id) return;

            const percursoSnap = await db.ref('configuracoes/percurso').once('value');
            const rastroSnap = await db.ref('rastros/' + id).once('value');
            
            if(!percursoSnap.exists()) return alert("Defina o trajeto no Admin primeiro!");
            
            // Desenha Percurso Oficial
            camadaPercurso.clearLayers();
            camadaPercurso.addData(percursoSnap.val());

            // Desenha Rastro do Piloto
            if(rastroSnap.exists()) {
                const dados = Object.values(rastroSnap.val());
                const coords = dados.map(p => [p.lat, p.lng]);
                rastroPoly.setLatLngs(coords);
                map.fitBounds(rastroPoly.getBounds());
                processarLog(dados, percursoSnap.val());
            } else {
                alert("Nenhum dado de rastro para este piloto.");
            }
        }

        function processarLog(rastro, percurso) {
            const painel = document.getElementById('details');
            let relatorio = "<strong>Relat√≥rio de Invas√£o:</strong><br><br>";
            const pts = rastro.map(p => turf.point([p.lng, p.lat], {vel: p.vel}));

            percurso.features.forEach((feat, i) => {
                const nome = feat.geometry.type === 'Polygon' ? `Radar ${i+1}` : `Waypoint ${i+1}`;
                
                if(feat.geometry.type === 'Polygon') {
                    const limite = feat.properties.velocidade || 60;
                    const excesso = pts.find(p => turf.booleanPointInPolygon(p, feat) && p.properties.vel > limite);
                    relatorio += excesso ? 
                        `<span class="infracao">‚ùå ${nome}: Excesso (${excesso.properties.vel.toFixed(1)} km/h)</span>` : 
                        `<span class="ok">‚úÖ ${nome}: Velocidade OK</span>`;
                } else {
                    const centro = turf.point(feat.geometry.coordinates);
                    const passou = pts.some(p => turf.distance(p, centro) <= (feat.properties.radius/1000));
                    relatorio += passou ? 
                        `<span class="ok">‚úÖ ${nome}: Validado</span>` : 
                        `<span class="infracao">‚ùå ${nome}: N√£o visitado</span>`;
                }
            });
            painel.innerHTML = relatorio;
        }
    </script>
</body>
</html>
