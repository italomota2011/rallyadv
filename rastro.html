<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rastro em Tempo Real</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, #map { height: 100vh; margin: 0; }
        .car-icon { background: #2c3e50; color: white; border: 2px solid #fff; border-radius: 50%; 
                    text-align: center; line-height: 25px; font-weight: bold; width: 25px!important; height: 25px!important; }
    </style>
</head>
<body>
<div id="map"></div>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = { apiKey: "SUA_API", databaseURL: "SUA_URL", projectId: "SEU_ID" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const map = L.map('map').setView([-23.5505, -46.6333], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const markers = {};
    let focado = false;

    // Carregar desenhos da prova
    db.ref('prova/configuracao').once('value', s => {
        if(s.exists()) L.geoJSON(s.val(), {
            style: { color: 'blue', weight: 2 },
            pointToLayer: (f, l) => f.properties.radius ? L.circle(l, {radius: f.properties.radius, color: 'orange'}) : null
        }).addTo(map);
    });

    // Monitorar carros
    db.ref('prova/carros').on('value', s => {
        const data = s.val();
        for(let id in data) {
            const c = data[id];
            if(c.lat && c.lng) {
                if(!focado) { map.setView([c.lat, c.lng], 14); focado = true; }
                if(!markers[id]) {
                    markers[id] = L.marker([c.lat, c.lng], {
                        icon: L.divIcon({ className: 'car-icon', html: c.id })
                    }).addTo(map);
                } else {
                    markers[id].setLatLng([c.lat, c.lng]);
                }
                markers[id].bindPopup(`Carro ${c.id}<br>Vel: ${c.velocidade}km/h`);
            }
        }
    });
</script>
</body>
</html>
