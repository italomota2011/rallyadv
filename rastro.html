<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Telemetria Detalhada - Rally</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #121212; color: white; }
        #sidebar { width: 320px; background: #1e1e1e; padding: 20px; overflow-y: auto; border-right: 1px solid #333; }
        #map { flex-grow: 1; }
        .card { background: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #e67e22; }
        h3 { margin-top: 0; color: #e67e22; }
        select, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 6px; border: none; }
        button { background: #e67e22; color: white; font-weight: bold; cursor: pointer; }
        .legenda { font-size: 11px; color: #aaa; margin-top: 10px; }
        .leg-item { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; }
        .box { width: 12px; height: 12px; border-radius: 2px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>üõ∞Ô∏è Telemetria</h3>
        <select id="carSelect"><option>A carregar...</option></select>
        <button onclick="analisar()">ANALISAR ROTA</button>
        
        <div id="infoPiloto" style="display:none;">
            <div class="card">
                <strong>PILOTO:</strong> <span id="txtNome">-</span><br>
                <strong>CATEGORIA:</strong> <span id="txtCat">-</span>
            </div>
            <div class="card" style="border-left-color: #e74c3c;">
                <strong>PENALIZA√á√ÉO ATUAL:</strong><br>
                <span id="txtPen" style="font-size: 20px; color: #e74c3c;">0 pts</span>
            </div>
        </div>

        <div class="legenda">
            <div class="leg-item"><div class="box" style="background:#2ecc71"></div> Velocidade OK</div>
            <div class="leg-item"><div class="box" style="background:#e74c3c"></div> Excesso (>10%)</div>
            <div class="leg-item"><div class="box" style="background:#3498db"></div> Rota Oficial / PCs</div>
            <div class="leg-item"><div class="box" style="background:#f39c12"></div> Radares Definidos</div>
        </div>
        <button style="background:#444; margin-top:20px;" onclick="location.href='admin.html'">VOLTAR</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const map = L.map('map').setView([-12.26, -38.96], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        let camadaRastro = L.featureGroup().addTo(map);
        let camadaOficial = L.featureGroup().addTo(map);

        db.ref('competidores').on('value', snap => {
            let options = '<option value="">Selecione o Ve√≠culo</option>';
            snap.forEach(c => { options += `<option value="${c.key}">Carro ${c.key} - ${c.val().nome}</option>`; });
            document.getElementById('carSelect').innerHTML = options;
        });

        async function analisar() {
            const id = document.getElementById('carSelect').value;
            if(!id) return;

            camadaRastro.clearLayers();
            camadaOficial.clearLayers();

            const config = (await db.ref('configuracoes/percurso').once('value')).val();
            const rastroSnap = await db.ref('rastros/' + id).once('value');
            const compSnap = await db.ref('competidores/' + id).once('value');
            
            if(!rastroSnap.exists()) return alert("Sem dados de rastro.");
            const rastroArr = Object.values(rastroSnap.val()).sort((a,b) => a.ts - b.ts);
            const comp = compSnap.val();

            // Mostrar Info
            document.getElementById('infoPiloto').style.display = 'block';
            document.getElementById('txtNome').innerText = comp.nome;
            document.getElementById('txtCat').innerText = comp.categoria;
            document.getElementById('txtPen').innerText = (150000 - comp.pontos) + " pts";

            // Desenhar Rota Oficial
            if(config) {
                L.geoJSON(config, {
                    style: (f) => f.geometry.type === 'Polygon' ? { color: '#f39c12', fillOpacity: 0.2 } : { color: '#3498db' },
                    pointToLayer: (f, latlng) => L.circle(latlng, { radius: f.properties.radius, color: '#3498db' })
                }).addTo(camadaOficial);
            }

            // Desenhar Rastro Colorido
            for(let i = 1; i < rastroArr.length; i++) {
                const p1 = rastroArr[i-1];
                const p2 = rastroArr[i];
                let cor = '#2ecc71';

                config?.features.forEach(feat => {
                    if(feat.geometry.type === 'Polygon') {
                        const vMaxTol = (feat.properties.velocidade || 60) * 1.1;
                        if(p2.vel > vMaxTol && turf.booleanPointInPolygon(turf.point([p2.lng, p2.lat]), feat)) {
                            cor = '#e74c3c';
                        }
                    }
                });

                L.polyline([[p1.lat, p1.lng], [p2.lat, p2.lng]], { color: cor, weight: 4 })
                 .addTo(camadaRastro)
                 .bindPopup(`<b>Velocidade:</b> ${p2.vel.toFixed(1)} km/h<br><b>Hora:</b> ${new Date(p2.ts).toLocaleTimeString()}`);
            }
            map.fitBounds(camadaRastro.getBounds());
        }
    </script>
</body>
</html>
