<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Rastro Rally - Analisador de Prova</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; display: flex; height: 100vh; font-family: sans-serif; background: #121212; color: white; }
        #sidebar { width: 320px; background: #1e1e1e; padding: 20px; z-index: 1000; overflow-y: auto; }
        #map { flex-grow: 1; }
        h2 { color: #e67e22; margin-top: 0; }
        select, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: none; font-size: 16px; }
        select { background: #333; color: white; }
        button { background: #e67e22; color: white; font-weight: bold; cursor: pointer; }
        #details { background: #252525; padding: 15px; border-radius: 8px; border-left: 4px solid #e67e22; font-size: 13px; line-height: 1.5; }
        .radar-label { color: #3498db !important; font-weight: bold; font-size: 11px; text-shadow: 1px 1px #000; background: none; border: none; box-shadow: none; }
        .infraction-dot { border: 2px solid white; border-radius: 50%; background: #ff4757; box-shadow: 0 0 10px #ff4757; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h2>üõ∞Ô∏è Analisador</h2>
        <label>Competidor:</label>
        <select id="carSelect">
            <option value="">A carregar competidores...</option>
        </select>
        <button onclick="drawTrack()">ANALISAR TRAJETO</button>
        
        <div id="details">
            <b>Legenda:</b><br>
            üü¶ Pol√≠gonos: Radares<br>
            üü† Linha: Rastro do Carro<br>
            üî¥ Pontos: Infra√ß√µes detectadas
        </div>
        
        <button style="background:#555; margin-top:20px;" onclick="location.href='admin.html'">VOLTAR AO PAINEL</button>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            storageBucket: "cronometro-rally.firebasestorage.app",
            messagingSenderId: "341731891354",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database(app);

        const map = L.map('map').setView([-12.26, -38.96], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        let trackLayer = L.layerGroup().addTo(map);
        let routeLayer = L.layerGroup().addTo(map);
        let percursoOficial = null;

        // 1. Carregar Percurso (Radares)
        db.ref('configuracoes/percurso').on('value', snap => {
            const data = snap.val();
            if(!data) return;
            percursoOficial = data;
            routeLayer.clearLayers();
            L.geoJSON(data, {
                style: { color: "#3498db", weight: 2, fillOpacity: 0.1 },
                onEachFeature: (f, l) => {
                    if(f.properties && f.properties.velocidade) {
                        l.bindTooltip(`Radar ${f.properties.velocidade}km/h`, {permanent: true, direction: 'center', className: 'radar-label'});
                    }
                }
            }).addTo(routeLayer);
        });

        // 2. Carregar Lista de Competidores (CORRIGIDO)
        db.ref('competidores').on('value', snap => {
            const select = document.getElementById('carSelect');
            let html = '<option value="">Selecione um carro...</option>';
            
            if (snap.exists()) {
                snap.forEach(child => {
                    const id = child.key;
                    const dados = child.val();
                    html += `<option value="${id}">Carro ${id} - ${dados.nome}</option>`;
                });
            } else {
                html = '<option value="">Nenhum competidor inscrito</option>';
            }
            select.innerHTML = html;
        });

        // 3. Desenhar Trajeto e Infra√ß√µes
        async function drawTrack() {
            const id = document.getElementById('carSelect').value;
            if(!id) return alert("Por favor, selecione um competidor.");

            const snap = await db.ref('rastros/' + id).once('value');
            if(!snap.exists()) return alert("Sem rastro de GPS para este carro.");

            trackLayer.clearLayers();
            const pontos = Object.values(snap.val()).sort((a, b) => a.ts - b.ts);
            const coords = pontos.map(p => [p.lat, p.lng]);

            // Linha do trajeto
            const poly = L.polyline(coords, {color: '#e67e22', weight: 4, opacity: 0.8}).addTo(trackLayer);
            
            let infracoes = 0;
            if(percursoOficial && percursoOficial.features) {
                pontos.forEach(p => {
                    const pt = turf.point([p.lng, p.lat]);
                    percursoOficial.features.forEach(feat => {
                        if(feat.geometry.type === 'Polygon' && turf.booleanPointInPolygon(pt, feat)) {
                            const limite = parseFloat(feat.properties.velocidade) || 60;
                            if(p.vel > limite) {
                                infracoes++;
                                L.circleMarker([p.lat, p.lng], {
                                    radius: 6,
                                    fillColor: "#ff4757",
                                    color: "#fff",
                                    weight: 2,
                                    fillOpacity: 1
                                }).bindPopup(`<b>INFRA√á√ÉO</b><br>Velocidade: ${p.vel.toFixed(1)} km/h<br>Limite: ${limite} km/h`)
                                  .addTo(trackLayer);
                            }
                        }
                    });
                });
            }

            map.fitBounds(poly.getBounds());

            document.getElementById('details').innerHTML = `
                <b>An√°lise Carro ${id}:</b><br>
                Pontos de GPS: ${pontos.length}<br>
                <b style="color:#ff4757">Infra√ß√µes: ${infracoes}</b><br>
                <small>* Radares azuis / Rastro laranja.</small>
            `;
        }
    </script>
</body>
</html>
